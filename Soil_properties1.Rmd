---
title: "Banana project, organic matter-microbiome"
output: html_document
date: "`r Sys.Date()`"
---

```{r, include=FALSE}
library(ggplot2)
library(tidyverse)
library(ggpubr)
library(gridExtra)
library(corrplot)
library(agricolae)
library(emmeans)
library(multcomp)
library(multcompView)
library(data.table)
library(tidyverse)
library(phyloseq)
library(vegan)
library(ape)
library(here)
library(readxl)
library(ggpubr)
library(geomtextpath)
library(knitr)
library(gridExtra)
library(Biostrings)
library(seqinr)
library(FSA)
library(agricolae)
library(MASS)
library(grid)
library(gridExtra)
library(emmeans)
library(multcomp)
library(broom)
library(viridis)
library(ALDEx2)
library(FactoMineR)
library(factoextra)
library(kableExtra)
library(scales)
library(dunn.test)
library(car)
library(corrplot)
library(eulerr)
library(ggforce)
library(ggrepel)
library(rstatix)
library(AICcmodavg)
library(ggthemes)

library(lmerTest)

```


# Data analysis octubre 2023


```{r colors, include=FALSE}
treat.colors <- c("control"= "green4" ,"control.amf"  = "darkseagreen" , "chicken.manure"= "royalblue1", "cow.manure" = "red3","mo.pellet"= "darkorchid1","compost"="chocolate4","control.legume"="darkolivegreen4")
treat.colors
treat.order <- c('control', 'control.amf', 'control.legume', "compost", "chicken.manure", "cow.manure", "mo.pellet") 
treat.labels <- c("Control", "Control\nAMF", "Control\nLegume", "Compost", "Chicken\nmanure", "Cow\nmanure", "Pellet")

```

## Properties of soil

Method to obtain each parameter. 

Five hundred grams of each soil sample were processed. The soils were air-dried at room temperature, sieved through a 2 mm sieve and homogenized. 
Oxidizable organic matter (%) was analyzed by oxidation with potassium dichromate in an acid medium and titrated with Mohr's salt, using a procedure adapted from that described by Walkley et al. (1934). 
Assimilable phosphorus (mg/kg) was analyzed according to the colorimetric method of Olsen et al. (1954). 
Soil exchange cations (mEq/kg), calcium, magnesium, potassium and sodium, were extracted with neutral 1N ammonium acetate and determined by flame atomic absorption spectrophotometry (Bower et al., 1952). 
The pH in aqueous extract 1:5 (v:v) and in potassium chloride extract 1:5 (v:v) were determined by potentiometry with a combined glass electrode, with a procedure based on UNE-ISO 10390:2012 (2012).
The electrical conductivity in extract 1:5 (mS/cm, µS/cm) by conductivity meter with the method based on UNE-EN 77308:2001 (2001). 

The analyses of these parameters were carried out by the Laboratory Unit of the Canarian Institute of Agricultural Research (ICIA) Canary Island, Spain.

```{r Import, include=FALSE}
#Esto se ha hecho para cargar el Excel de los datos iniciales (ojo, para poner el directorio de donde esta tu archivo excel, se tiene que cambiar \, por /), y para hacer la media de cada tratamiento, ya que de cada tratamiento hay 3 repeticiones. El simbolo %>% se llaman tuberias (the pipe) vienen de la libreria (tinyverse) (esta libreria sirve para mantener R más ordenado). Las tuberias funcionan usando el resultado de una operación(out) y convirtiendolo en el imput de otra. En el caso del codigo  "soil.summ <- soil_prop %>% group_by(treatment,  time) %>% summarise(across(.cols=everything(), .fns=mean),.groups = "drop")" quiere decir lo siguiente: hemos creado un objeto nuevo que es soil.summ, que es_ el archivo de excel soil_prop el que hacemos una serie de operaciones en cadena (tuberia) donde agrupamos solamente por tratamiento y tiempo (group_by,) y en ese agrupamiento queremos de todas las columnas, .cols=every, que haga la funcion de la media (fns=mean). NULL significa que no tenga en cuenta esas columnas. $ es para seleccionar cosas especificas. 

soil_prop <- readxl::read_excel("raw_files/soil_prop_2.xlsx")

soil.summ <- soil_prop %>% group_by(treatment,  time) %>% 
  summarise(across(.cols=everything(),.fns=mean),.groups = "drop")

soil.summ.sd <- soil_prop %>% group_by(treatment,  time) %>% 
  summarise(across(.cols=everything(),.fns=list(mean = mean, sd = sd)),.groups = "drop")

soil.summ$rep <- NULL
soil.summ$soil.id <- NULL

```

### Evolution of each parameter in the different times of the experiment


```{r over the time, include=FALSE}

#En este codigo veremos la evolucion de los distintos parametros en el tiempo. La función "aes" sirve para indicar en un grafico cual es tu X,y. Debes indicar en texto quien es quien.Toda la información de los datos referido al grafico es lo que va dentro del parentesis. Los adornos van fuera con el signo de +. La funcion "geom_line" sirve para elegir el tipo de grafico que quieres. 

#add media y lo que es 
org.mat.plotsd <- soil.summ.sd%>% ggplot(aes(x=time, group= treatment, col= treatment, y= org.matter_mean))+
  geom_line(linewidth=1)+
  theme_clean()+
  xlab("")+
  ylab("Oxidable organic matter (%)")+
  scale_color_manual(values= treat.colors)+
  geom_point()+
  geom_errorbar(aes(ymin=org.matter_mean-org.matter_sd, ymax=org.matter_mean+org.matter_sd), width=0.2)+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5))+
  guides(col=guide_legend(title="Treatment"))+
  labs(title = "Oxidable organic matter over the time.", subtitle = "", caption="Mean and SD of each treatment")+
  theme(
    plot.title = element_text(size = 11),
    plot.caption = element_text(size = 10))
org.mat.plotsd
ggsave(org.mat.plotsd, file="soil_parameters_result/organicmatter.png", width= 1900,height= 1200, units= "px")

phosp.plotsd <- soil.summ.sd%>% ggplot(aes(x=time, group= treatment, col= treatment, y=phosphorus_mean))+
  geom_line(linewidth=1)+
  theme_clean()+
  xlab("")+
  ylab("Phosphorus mg/Kg")+
  scale_color_manual(values= treat.colors)+
  geom_point()+
  geom_errorbar(aes(ymin=phosphorus_mean-phosphorus_sd, ymax=phosphorus_mean+phosphorus_sd), width=0.2)+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5))+
  guides(col=guide_legend(title="Treatment"))+
  labs(title = "Phosphorus over the time.", subtitle = "", caption="Mean and SD of each treatment")+
  theme(
    plot.title = element_text(size = 11),
    plot.caption = element_text(size = 10))
phosp.plotsd
ggsave(phosp.plotsd, file="soil_parameters_result/phosphorus.png", width= 1900,height= 1200, units= "px")
calcium.plotsd <- soil.summ.sd%>% ggplot(aes(x=time, group= treatment, col= treatment, y= calcium_mean))+
  geom_line(linewidth=1)+
  theme_clean()+
  xlab("")+
  ylab("Calcium mEq/kg")+
  scale_color_manual(values= treat.colors)+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5))+
  guides(col=guide_legend(title="Treatment"))+
  geom_point()+
  geom_errorbar(aes(ymin=calcium_mean-calcium_sd, ymax=calcium_mean+calcium_sd), width=0.2)+
  labs(title = "Calcium over the time.", subtitle = "", caption="Mean and SD of each treatment")+
  theme(
    plot.title = element_text(size = 11),
    plot.caption = element_text(size = 10))
calcium.plotsd
ggsave(calcium.plotsd, file="soil_parameters_result/calcium.png", width= 1900,height= 1200, units= "px")
sodium.plotsd <- soil.summ.sd%>% ggplot(aes(x=time, group= treatment, col= treatment, y= sodium_mean))+
  geom_line(linewidth=1)+
  theme_clean()+
  xlab("")+
  ylab("Sodium mEq/kg")+
  scale_color_manual(values= treat.colors)+
  geom_point()+
  geom_errorbar(aes(ymin=sodium_mean-sodium_sd, ymax=sodium_mean+sodium_sd), width=0.2)+
  guides(col=guide_legend(title="Treatment"))+
  geom_point()+
  labs(title = "Sodium over the time.", subtitle = "", caption="Mean and SD of each treatment")+
  theme(
    plot.title = element_text(size = 11),
    plot.caption = element_text(size = 10))
sodium.plotsd
ggsave(sodium.plotsd, file="soil_parameters_result/sodium.png", width= 1900,height= 1200, units= "px")
potassium.plotsd <- soil.summ.sd%>% ggplot(aes(x=time, group= treatment, col= treatment, y= potassium_mean))+
  geom_line(linewidth=1)+
  theme_clean()+
  xlab("")+
  ylab("Potassium mEq/kg")+
  scale_color_manual(values= treat.colors)+
  geom_point()+
  guides(col=guide_legend(title="Treatment"))+
  geom_errorbar(aes(ymin=potassium_mean-potassium_sd, ymax=potassium_mean+potassium_sd), width=0.2)+
  labs(title = "Potassium over the time.", subtitle = "", caption="Mean and SD of each treatment")+
  guides(col=guide_legend(title="Treatment"))+
  theme(
    plot.title = element_text(size = 11),
    plot.caption = element_text(size = 10))
potassium.plotsd
ggsave(potassium.plotsd, file="soil_parameters_result/potassium.png", width= 1900,height= 1200, units= "px")
pH_water.plotsd <- soil.summ.sd%>% ggplot(aes(x=time, group= treatment, col= treatment, y= ph.water_mean))+
  geom_line(linewidth=1)+
  theme_clean()+
  xlab("")+
  ylab("pH water udes.")+
  scale_color_manual(values= treat.colors)+
  geom_point()+
  geom_errorbar(aes(ymin=ph.water_mean-ph.water_sd, ymax=ph.water_mean+ph.water_sd), width=0.2)+
  labs(title = "pH water over the time.", subtitle = "", caption="Mean and SD of each treatment")+
  guides(col=guide_legend(title="Treatment"))+
  theme(
    plot.title = element_text(size = 11),
    plot.caption = element_text(size = 10))
pH_water.plotsd
ggsave(pH_water.plotsd, file="soil_parameters_result/phwater.png", width= 1900,height= 1200, units= "px")

conductivity.plotsd <- soil.summ.sd%>% ggplot(aes(x=time, group= treatment, col= treatment, y= conductivity_mean))+
  geom_line(linewidth=1)+
  theme_clean()+
  xlab("")+
  ylab("Conductivity mS/cm")+
  scale_color_manual(values= treat.colors)+
  geom_point()+
  geom_errorbar(aes(ymin=conductivity_mean-conductivity_sd, ymax=conductivity_mean+conductivity_sd), width=0.2)+
  labs(title = "Conductivity over the time.", subtitle = "", caption="Mean and SD of each treatment")+
  guides(col=guide_legend(title="Treatment"))+
  theme(
    plot.title = element_text(size = 11),
    plot.caption = element_text(size = 10))
conductivity.plotsd
ggsave(conductivity.plotsd, file="soil_parameters_result/conductivity.png", width= 1900,height= 1200, units= "px")
nitrogen.plotsd <- soil.summ.sd%>% ggplot(aes(x=time, group= treatment, col= treatment, y= nitrogen_mean))+
  geom_line(linewidth=1)+
  theme_clean()+
  xlab("Time")+
  ylab("Nitrogen (%)")+
  scale_color_manual(values= treat.colors)+
  geom_point()+
  geom_errorbar(aes(ymin=nitrogen_mean-nitrogen_sd, ymax=nitrogen_mean+nitrogen_sd), width=0.2)+
   labs(title = "Nitrogen over the time.", subtitle = "", caption="Mean and SD of each treatment")+
  guides(col=guide_legend(title="Treatment"))+
  theme(
    plot.title = element_text(size = 11),
    plot.caption = element_text(size = 10))
nitrogen.plotsd
ggsave(nitrogen.plotsd, file="soil_parameters_result/nitrogen.png", width= 1900,height= 1200, units= "px")

```



```{r together, echo=FALSE}

soilparameters1 <- ggpubr::ggarrange(org.mat.plotsd+ theme(legend.position="none"), 
                            sodium.plotsd+ theme(legend.position="none"), 
                            calcium.plotsd + theme(legend.position="none"),
                            potassium.plotsd+ theme(legend.position="none"),
                            phosp.plotsd + theme(legend.position="right"))
                          
soilparameters1


soilparameters2 <- ggarrange(nitrogen.plotsd + theme(legend.position="none"), 
                            pH_water.plotsd + theme(legend.position="none"), 
                            conductivity.plotsd+ theme(legend.position="right"))
soilparameters2

ggsave(soilparameters1, file="soil_parameters_result/soilparameters1.png", width= 3800, height= 3600, units= "px")
ggsave(soilparameters2, file="soil_parameters_result/soilparameters2.png", width= 3800, height= 3600, units= "px")


#respiration_basal_all <- ggarrange(plot_basal_t0 + theme(legend.position="none"), plot_basal_t1 + theme(legend.position="none"), plot_basal_t2 + theme(legend.position="none"), plot_basal_t3+ theme(legend.position="none"), plot_basal_t4 + theme(legend.position="none") , ncol = 3)

#figureall <- ggarrange(org.mat.plotsd, phosp.plotsd, pH_water.plotsd, potassium.plotsd, sodium.plotsd,calcium.plotsd, nitrogen.plotsd, conductivity.plotsd,labels = c("A", "B", "C", "D", "E", "F", "G", "H"),font.label = list (size = 10, color= "black", position= "right"),common.legend = TRUE, legend = "bottom",vjust = 10,col = 3, nrow = 3)title <- text_grob("Soil properties over the time",color ="black", face = "bold", size = 14)figure_title <- annotate_figure(figureall, top=title, bottom = text_grob("Mean and sd of each treatments"))grid.draw(figure_title)

```

### Statistical analysis.

### Check the correlation between the variables to analyse the most interesting ones.

```{r Correlogram, echo=FALSE}
soil_prop_cor <- soil_prop
soil_prop_cor$rep <- NULL
soil_prop_cor$soil.id <- NULL
soil_prop_cor$treatment <- NULL
soil_prop_cor$time <- NULL
cor.matrix <- soil_prop_cor %>% cor()

cor.mat.test <- cor.mtest(cor.matrix)

correlation <- corrplot(cor.matrix, p.mat=cor.mat.test$p, sig.level = 0.05, order= "hclust", type= "upper", method= "number", insig = "pch", pch=4,number.cex = 0.75)

```

The most interesing variables seem to be pH.water, organic matter, conductivity and NPKCa values. The rest could be omitted. 

## Differences between treatments at the start of the experiment (t0)

Para comprobar si hay diferencias significativas o no. 
1.Dif. entre tratamientos y tiempos. 
2.Dif. entre 1 tratamiento a lo largo del tiempo. 

```{r Materia organica stats, echo=FALSE}

#Vamos analizar diferencias en el primer muestreo (to), por ello usamos la funcion subset que es un condicional como simbolo de dolar o funcion subset, para elegir determinadas variables dentro de un objeto,  significa solo analizar del archivo soil_prop, la columan soil_prop$time que sea igual a t0). Le hacemos un modelo de regresion lineal, o se puede analizar directamnte con anova. 
#comprobamos la normalidad de los datos por tratamiento y no entre tratamientos. Los datos al interaccionar entre tratamietnos no son normales, ya que por los procesos biologicos son mas altos en algunos tratamientos que otros. Asumiendo esto, los analisis estadisticos se haran igualmente con aproximacion parametrica. 

soilt0 <- subset(soil_prop, soil_prop$time== "t0")
shapiro.test(soilt0$org.matter)#ahora vamos a comprobar la normalidad de los datos. Los datos no son normales. 
soil_prop %>% group_by(treatment) %>% shapiro_test(org.matter) #aqui comprobamos la normalidad de los datos de materia organica en cada tratamiento. Todos son normales.

ggqqplot(data = soil_prop, "org.matter", facet.by = "treatment")
leveneTest(org.matter~ treatment, data=soilt0) #test de Levene para el analisis de la varianza

anova_orgmattert0 <- aov(org.matter ~ treatment, data=soilt0) #hay diferencias significativas
anova_orgmattert0<-summary(aov(org.matter ~ treatment, data=soilt0))
pvalue_anova_orgmattert0 <- anova_orgmattert0[[1]][["Pr(>F)"]][1]

#Puesto que hay direferencias sig. vamos a comprobar entre que tratamientos. POST-HOC.

#### hsd tukey from agricolae::
tukey_orgmatter <- HSD.test(aov(org.matter ~ treatment, data=soilt0), "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")
tukey_orgmatter

#crear un grafico con la media de la los valores de materia organica de t0, y la letra de HSDTukey)
avgm <- aggregate(org.matter ~ treatment, data=soilt0, FUN= mean)
plot_orgmatter_t0 <- soilt0 %>% ggplot(aes(x= factor(treatment, level= treat.order), y= org.matter, fill=treatment))+
  geom_point(size= 7, pch= 21, col= "black", aes(fill= treatment), position= position_jitter(width=0.1, height=0))+
  scale_fill_manual(values= treat.colors)+
  scale_color_manual(values= treat.colors)+
  ylab("Oxidable organic matter (%)")+
  xlab("")+
  theme_classic2()+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5))+
  scale_x_discrete(labels= treat.labels)+
  guides(fill=guide_legend(title="Treatment"))+
  stat_summary(fun=mean, aes(x= treatment, y = org.matter),geom= "crossbar", width=0.5, colour= "grey20", data=avgm)+
  geom_text(data=tukey_orgmatter, aes(x=treatment, y = org.matter, label= groups), color="black", nudge_x= 0.2, nudge_y= 0.25)+
  labs(title = "", subtitle = "", caption = "Different letters indicate statistically significant differences between each treatment at T0.\nCrossbar indicate the average of the three samples", size = 10 )+
  ggtitle("Oxidizable organic matter T0 (%)", subtitle= paste("ANOVA (HSDTukey) p-value: ", format(pvalue_anova_orgmattert0, scientific= TRUE, digits=2 ), sep= ""))+
  theme(
    plot.title = element_text(size = 11),
    plot.subtitle = element_text(size = 10),
    plot.caption = element_text(size = 8))

plot_orgmatter_t0
ggsave(plot_orgmatter_t0, file="soil_parameters_result/org_matter_t0.png", width= 1900,height= 1200, units= "px")

```

```{r Phosphorous stats, echo=FALSE}
shapiro.test(soilt0$phosphorus)#data no normal 
soilt0 %>% group_by(treatment) %>% shapiro_test(phosphorus) #all treatment are normal
ggqqplot(data = soil_prop, "phosphorus", facet.by = "treatment")
leveneTest(phosphorus~ treatment, data= soilt0)#equal variance
anova_phospht0 <- aov(phosphorus ~ treatment, data=soilt0)
anova_phospht0<- summary(aov(phosphorus ~ treatment, data=soilt0))
pvalue_anova_phospht0 <- anova_phospht0[[1]][["Pr(>F)"]][1]
tukey_phosphorus <- HSD.test(aov(phosphorus ~ treatment, data=soilt0), "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")


avgpho <- aggregate(phosphorus ~ treatment, data=soilt0, FUN= mean)
plot_phosphorus_t0 <- soilt0 %>% ggplot(aes(x= factor(treatment, level= treat.order), y= phosphorus, fill=treatment))+
  geom_point(size= 7, pch= 21, col= "black", aes(fill= treatment), position= position_jitter(width=0.1, height=0))+
  scale_fill_manual(values= treat.colors)+
  scale_color_manual(values= treat.colors)+
  ylab("Phosphorus mg/Kg")+
  xlab("")+
  theme_classic2()+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5))+
  scale_x_discrete(labels= treat.labels)+
  guides(fill=guide_legend(title="Treatment"))+
  stat_summary(fun=mean, aes(x= treatment, y = phosphorus),
               geom= "crossbar",  width=0.5, colour= "grey20", data=avgpho)+
  geom_text(data=tukey_phosphorus, aes(x=treatment, y = phosphorus, label= groups), 
            colour="black", nudge_x= 0.2, nudge_y= 3)+
  labs(title = "", subtitle = "", caption = "Different letters indicate statistically significant differences between each treatment at T0.\nCrossbar indicate the average of the three samples", size = 10 )+
  ggtitle("Phosphorus T0", subtitle= paste("ANOVA (HSDTukey) p-value: ", format(pvalue_anova_phospht0, scientific= TRUE, digits=2 ), sep= ""))+
  theme(
    plot.title = element_text(size = 11),
    plot.subtitle = element_text(size = 10),
    plot.caption = element_text(size = 8))
plot_phosphorus_t0
ggsave(plot_phosphorus_t0, file="soil_parameters_result/phosphorus_t0.png", width= 1900,height= 1200, units= "px")
```

```{r ph water stast, echo=FALSE}
shapiro.test(soilt0$ph.water)
soilt0 %>% group_by(treatment) %>% shapiro_test(ph.water) #normal data
ggqqplot(data = soil_prop, "ph.water", facet.by = "treatment")
leveneTest(ph.water~ treatment, data= soilt0)#equal variance

anova_phwatert0 <- aov(ph.water ~ treatment, data=soilt0)
anova_phwatert0<- summary(aov(ph.water ~ treatment, data=soilt0))
pvalue_anova_phwatert0<- anova_phwatert0[[1]][["Pr(>F)"]][1]
tukey_phwater <- HSD.test(aov(ph.water ~ treatment, data=soilt0), "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")

avgphwater <- aggregate(ph.water ~ treatment, data=soilt0, FUN= mean)
plot_phwater_t0 <- soilt0 %>% ggplot(aes(x= factor(treatment, level= treat.order), y= ph.water, fill=treatment))+
  geom_point(size= 7, pch= 21, col= "black", aes(fill= treatment), position= position_jitter(width=0.1, height=0))+
  scale_color_manual(values= treat.colors)+
  scale_fill_manual(values= treat.colors)+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5))+
  scale_x_discrete(labels= treat.labels)+
  guides(fill=guide_legend(title="Treatment"))+
  ylab("pH water udes.")+
  xlab("")+
  theme_classic2()+
  stat_summary(fun=mean, aes(x= treatment, y = ph.water),
               geom= "crossbar",  width=0.5, colour= "grey20", data=avgphwater)+
  geom_text(data=tukey_phwater, aes(x=treatment, y = ph.water, label= groups), 
            colour="black", nudge_x= 0.2, nudge_y= 0.05)+
  labs(title = "", subtitle = "", caption = "Different letters indicate statistically significant differences between each treatment at T0.\nCrossbar indicate the average of the three samples", size = 10 )+
  ggtitle("pH water T0", subtitle= paste("ANOVA (HSDTukey) p-value: ", format(pvalue_anova_phwatert0, scientific= TRUE, digits=2 ), sep= ""))+
  theme(
    plot.title = element_text(size = 11),
    plot.subtitle = element_text(size = 10),
    plot.caption = element_text(size = 8))
plot_phwater_t0
ggsave(plot_phwater_t0, file="soil_parameters_result/phwater_t0.png", width= 1900,height= 1200, units= "px")
```

```{r conductivity stats, echo=FALSE}
shapiro.test(soilt0$conductivity) #data no normal 
soil_prop %>% group_by(treatment) %>% shapiro_test(conductivity) #all treatment are normal except one
soil_prop$sqrt_conductivity <- sqrt(soil_prop$conductivity) #transformation data
soil_prop %>% group_by(treatment) %>% shapiro_test(sqrt_conductivity) #all treatment are normal now indepndt of time
soilt0 %>% group_by(treatment) %>% shapiro_test(conductivity)
soilt0$sqrt_conductivity <- sqrt(soilt0$conductivity)
shapiro.test(soilt0$sqrt_conductivity)
soilt0 %>% group_by(treatment) %>% shapiro_test(sqrt_conductivity)
leveneTest(sqrt_conductivity~ treatment, data= soilt0) # equal variance

anova_conductivityt0 <- aov(sqrt_conductivity~ treatment, data=soilt0)
anova_conductivityt0<- summary(aov(sqrt_conductivity ~ treatment, data=soilt0))
pvalue_anova_conductivityt0<- anova_conductivityt0[[1]][["Pr(>F)"]][1]

tukey_conductivity <- HSD.test(aov(sqrt_conductivity~ treatment, data=soilt0), "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")

avgconduc <- aggregate(sqrt_conductivity ~ treatment, data=soilt0, FUN= mean)

plot_conduc_t0 <- soilt0 %>% ggplot(aes(x= factor(treatment, level= treat.order), y= sqrt_conductivity, fill=treatment))+
  geom_point(size= 7, pch= 21, col= "black", aes(fill= treatment), position= position_jitter(width=0.1, height=0))+
  scale_color_manual(values= treat.colors)+
  scale_fill_manual(values= treat.colors)+
  ylab("Conductivity mS/cm.")+
  xlab("")+
  theme_classic2()+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5))+
  scale_x_discrete(labels= treat.labels)+
  guides(fill=guide_legend(title="Treatment"))+
  stat_summary(fun=mean, aes(x= treatment, y = sqrt_conductivity),
               geom= "crossbar",  width=0.5, colour= "grey20", data=avgconduc)+
  geom_text(data=tukey_conductivity, aes(x=treatment, y = sqrt_conductivity, label= groups), 
            colour="black", nudge_x= 0.2, nudge_y= 0.05)+
  labs(title = "", subtitle = "", caption = "Different letters indicate statistically significant differences between each treatment at T0.\nCrossbar indicate the average of the three samples", size = 10 )+
  ggtitle("Conductivity T0", subtitle= paste("Data transformed. ANOVA (HSDTukey) p-value: ", format(pvalue_anova_conductivityt0, scientific= TRUE, digits=2 ), sep= ""))+
  theme(
    plot.title = element_text(size = 11),
    plot.subtitle = element_text(size = 10),
    plot.caption = element_text(size = 8))
plot_conduc_t0

ggsave(plot_conduc_t0, file="soil_parameters_result/conduc_t0.png", width= 1900,height= 1200, units= "px")
```


```{r stats calcium, echo=FALSE}
shapiro.test(soilt0$calcium)#normal data
leveneTest(calcium~ treatment, data= soilt0)#equal variance
anova_calciumt0 <- aov(calcium ~ treatment, data=soilt0)
anova_calciumt0<- summary(aov(calcium ~ treatment, data=soilt0))
pvalue_anova_calciumt0<- anova_calciumt0[[1]][["Pr(>F)"]][1]
tukey_calcium <- HSD.test(aov(calcium ~ treatment, data=soilt0), "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")
tukey_calcium
avgcalcium <- aggregate(calcium ~ treatment, data=soilt0, FUN= mean)

plot_calcium_t0 <- soilt0 %>% ggplot(aes(x= factor(treatment, level= treat.order), y= calcium, fill=treatment))+
  geom_point(size= 7, pch= 21, col= "black", aes(fill= treatment), position= position_jitter(width=0.1, height=0))+
  scale_color_manual(values= treat.colors)+
  scale_fill_manual(values= treat.colors)+
  ylab("Calcium mEq/kg.")+
  xlab("")+
  theme_classic2()+
  scale_x_discrete(labels= treat.labels)+
  guides(fill=guide_legend(title="Treatment"))+
  stat_summary(fun=mean, aes(x= treatment, y = calcium),
               geom= "crossbar",  width=0.5, colour= "grey20", data=avgcalcium)+
  geom_text(data=tukey_calcium, aes(x=treatment, y = calcium, label= groups), 
            colour="black", nudge_x= 0.2, nudge_y= 3)+
  labs(title = "", subtitle = "", caption = "Different letters indicate statistically significant differences between each treatment at T0.\nCrossbar indicate the average of the three samples", size = 10 )+
  ggtitle("Calcium T0", subtitle= paste("ANOVA (HSDTukey) p-value: ", format(pvalue_anova_calciumt0, scientific= TRUE, digits=2 ), sep= ""))+
  theme(
    plot.title = element_text(size = 11),
    plot.subtitle = element_text(size = 10),
    plot.caption = element_text(size = 8))
 
plot_calcium_t0
ggsave(plot_calcium_t0, file="soil_parameters_result/calcium_t0.png", width= 1900,height= 1200, units= "px")

```

```{r stats sodium, echo=FALSE}
shapiro.test(soilt0$sodium)#normal data
leveneTest(sodium~ treatment, data= soilt0) #equal variance
anova_sodiumt0 <- aov(sodium ~ treatment, data=soilt0)
anova_sodiumt0<- summary(aov(sodium ~ treatment, data=soilt0))
pvalue_anova_sodiumt0<- anova_sodiumt0[[1]][["Pr(>F)"]][1]

tukey_sodium <- HSD.test(aov(sodium ~ treatment, data=soilt0), "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")
avgsodium <- aggregate(sodium ~ treatment, data=soilt0, FUN= mean)

plot_sodium_t0 <- soilt0 %>% ggplot(aes(x= factor(treatment, level= treat.order), y= sodium, fill=treatment))+
  geom_point(size= 7, pch= 21, col= "black", aes(fill= treatment), position= position_jitter(width=0.1, height=0))+
  scale_color_manual(values= treat.colors)+
  scale_fill_manual(values= treat.colors)+
  ylab("sodium mEq/kg.")+
  xlab("")+
  theme_classic2()+
  scale_x_discrete(labels= treat.labels)+
  guides(fill=guide_legend(title="Treatment"))+
  stat_summary(fun=mean, aes(x= treatment, y = sodium),
               geom= "crossbar",  width=0.5, colour= "grey20", data=avgsodium)+
  geom_text(data=tukey_sodium, aes(x=treatment, y = sodium, label= groups), 
            colour="black", nudge_x= 0.2, nudge_y= 0.2)+
  labs(title = "", subtitle = "", caption = "Different letters indicate statistically significant differences between each treatment at T0.\nCrossbar indicate the average of the three samples", size = 10 )+
  ggtitle("Sodium T0", subtitle= paste("ANOVA (HSDTukey) p-value: ", format(pvalue_anova_sodiumt0, scientific= FALSE, digits=2 ), sep= ""))+
  theme(
    plot.title = element_text(size = 11),
    plot.subtitle = element_text(size = 10),
    plot.caption = element_text(size = 8))
  
plot_sodium_t0
ggsave(plot_sodium_t0, file="soil_parameters_result/sodium_t0.png", width= 1900,height= 1200, units= "px")
```

```{r stats potassium, echo=FALSE}
shapiro.test(soilt0$potassium) #normal data
leveneTest(potassium~ treatment, data= soilt0) #equal variance
anova_potassiumt0 <- aov(potassium ~ treatment, data=soilt0)
anova_potassiumt0<- summary(aov(potassium ~ treatment, data=soilt0))
pvalue_anova_potassiumt0<- anova_potassiumt0[[1]][["Pr(>F)"]][1]

tukey_potassium <- HSD.test(aov(potassium ~ treatment, data=soilt0), "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")
avgpotassium <- aggregate(potassium ~ treatment, data=soilt0, FUN= mean)

plot_potassium_t0 <- soilt0 %>% ggplot(aes(x= factor(treatment, level= treat.order), y= potassium, fill=treatment))+
  geom_point(size= 7, pch= 21, col= "black", aes(fill= treatment), position= position_jitter(width=0.1, height=0))+
  scale_color_manual(values= treat.colors)+
  scale_fill_manual(values= treat.colors)+
  ylab("potassium mEq/kg.")+
  xlab("")+
  theme_classic2()+
  scale_x_discrete(labels= treat.labels)+
  guides(fill=guide_legend(title="Treatment"))+
  stat_summary(fun=mean, aes(x= treatment, y = potassium),
               geom= "crossbar",  width=0.5, colour= "grey20", data=avgpotassium)+
  geom_text(data=tukey_potassium, aes(x=treatment, y = potassium, label= groups), 
            colour="black", nudge_x= 0.2, nudge_y= 0.6)+
  labs(title = "", subtitle = "", caption = "Different letters indicate statistically significant differences between each treatment at T0.\nCrossbar indicate the average of the three samples", size = 10 )+
  ggtitle("Potassium T0", subtitle= paste("ANOVA (HSDTukey) p-value: ", format(pvalue_anova_potassiumt0, scientific= TRUE, digits=2 ), sep= ""))+
  theme(
    plot.title = element_text(size = 11),
    plot.subtitle = element_text(size = 10),
    plot.caption = element_text(size = 8))

plot_potassium_t0
ggsave(plot_potassium_t0, file="soil_parameters_result/potassium_t0.png", width= 1900,height= 1200, units= "px")

```


```{r stats nitrogent0, echo=FALSE}
shapiro.test(soilt0$nitrogen)#data no normal 
soil_prop %>% group_by(treatment) %>% shapiro_test(nitrogen) #all the treatments are normal except one
soilt0$log_nitrogen <- log(soilt0$nitrogen) #transformation
shapiro.test(soilt0$log_nitrogen)
soil_prop$log_nitrogen <- log(soil_prop$nitrogen)#transformation
soil_prop %>% group_by(treatment) %>% shapiro_test(log_nitrogen)#all the treatments are normal
leveneTest(log_nitrogen~ treatment, data= soilt0) # equal variance

anova_nitrogen0 <- aov(log_nitrogen ~ treatment, data=soilt0)
anova_nitrogen0 <- summary(aov(log_nitrogen ~ treatment, data=soilt0))
pvalue_anova_nitrogent0<- anova_nitrogen0[[1]][["Pr(>F)"]][1]
tukey_nitrogen <- HSD.test(aov(log_nitrogen ~ treatment, data=soilt0), "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")
avgnitrogen <- aggregate(log_nitrogen ~ treatment, data=soilt0, FUN= mean)
avgnitrogen

plot_nitrogen_t0 <- soilt0 %>% ggplot(aes(x= factor(treatment, level= treat.order), y= log_nitrogen, col=treatment))+
   geom_point(size= 7, pch= 21, col= "black", aes(fill= treatment), position= position_jitter(width=0.1, height=0))+
  scale_color_manual(values= treat.colors)+
  scale_fill_manual(values= treat.colors)+
  ylab("nitrogen (%)")+
  xlab("")+
  theme_classic2()+
  scale_x_discrete(labels= treat.labels)+
  stat_summary(fun=mean, aes(x= treatment, y = log_nitrogen),
               geom= "crossbar",  width=0.5, colour= "grey20", data=avgnitrogen)+
  geom_text(data=tukey_nitrogen, aes(x=treatment, y = log_nitrogen, label= groups), 
            colour="black", nudge_x= 0.2, nudge_y= 0.05)+
  guides(fill=guide_legend(title="Treatment"))+
  labs(title = "", subtitle = "", caption = "Different letters indicate statistically significant differences between each treatment at T0.\nCrossbar indicate the average of the three samples", size = 10 )+
  ggtitle("Nitrogen T0", subtitle= paste("Data transformed. ANOVA (HSDTukey) p-value: ", format(pvalue_anova_nitrogent0, scientific= TRUE, digits=2 ), sep= ""))+
  theme(
    plot.title = element_text(size = 11),
    plot.subtitle = element_text(size = 10),
    plot.caption = element_text(size = 8))
plot_nitrogen_t0
ggsave(plot_nitrogen_t0, file="soil_parameters_result/nitrogen_t0.png", width= 1900,height= 1200, units= "px")

```

### Differences between treatments at the end of the experiment (t4)


```{r stats org.matter at the end, inclue=TRUE}
soilt4 <- subset(soil_prop, soil_prop$time== "t4")

shapiro.test(soilt4$org.matter) #normal data
leveneTest(org.matter~ treatment, data=soilt4) #equal variances
anova_orgmattert4 <- aov(org.matter ~ treatment, data=soilt4) #sig. different
anova_orgmattert4<- summary(aov(org.matter ~ treatment, data=soilt4))
pvalue_anova_orgmattert4<- anova_orgmattert4[[1]][["Pr(>F)"]][1]

tukey_orgmattert4 <- HSD.test(aov(org.matter ~ treatment, data=soilt4), "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")
avgmt4 <- aggregate(org.matter ~ treatment, data=soilt4, FUN= mean)
plot_orgmatter_t4 <- soilt4 %>% ggplot(aes(x= factor(treatment, level= treat.order), y= org.matter, fill=treatment))+
  geom_point(size= 7, pch= 22, col= "black", aes(fill= treatment), position= position_jitter(width=0.1, height=0))+
  scale_color_manual(values= treat.colors)+
  scale_fill_manual(values= treat.colors)+
  ylab("Oxidable organic matter (%)")+
  xlab("")+
  scale_x_discrete(labels= treat.labels)+
  theme_classic2()+
  guides(fill=guide_legend(title="Treatment"))+
  stat_summary(fun=mean, aes(x= treatment, y = org.matter),
               geom= "crossbar", width=0.6, colour= "black", data=avgmt4)+
  geom_text(data=tukey_orgmattert4, aes(x=treatment, y = org.matter, label= groups), color="black", nudge_x= 0.2, nudge_y= 0.2)+
  labs(title = "", subtitle = "", caption = "Different letters indicate statistically significant differences between each treatment at T4.\nCrossbar indicate the average of the three samples", size = 10 )+
  ggtitle("Oxidizable organic matter T4", subtitle= paste("Data transformed. ANOVA (HSDTukey) p-value: ", format(pvalue_anova_orgmattert4, scientific= TRUE, digits=2 ), sep= ""))+
  theme(
    plot.title = element_text(size = 11),
    plot.subtitle = element_text(size = 10),
    plot.caption = element_text(size = 8))
plot_orgmatter_t4
ggsave(plot_orgmatter_t4, file="soil_parameters_result/orgmatter_t4.png", width= 1900,height= 1200, units= "px")
```


```{r pho stas t4, echo=FALSE}
shapiro.test(soilt4$phosphorus) #no normal data
soilt4 %>% group_by(treatment) %>% shapiro_test(phosphorus) # all treatments normal
ggqqplot(data = soil_prop, "phosphorus", facet.by = "treatment")

leveneTest(phosphorus~ treatment, data= soilt4)#equal variance
anova_phospht4 <- aov(phosphorus ~ treatment, data=soilt4)
anova_phospht4<- summary(aov(phosphorus ~ treatment, data=soilt4))
pvalue_anova_phospht4 <- anova_phospht4[[1]][["Pr(>F)"]][1]
tukey_phosphorus <- HSD.test(aov(phosphorus ~ treatment, data=soilt4), "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")


avgpho <- aggregate(phosphorus ~ treatment, data=soilt4, FUN= mean)
plot_phosphorus_t4 <- soilt4 %>% ggplot(aes(x= factor(treatment, level= treat.order), y= phosphorus, fill=treatment))+
  geom_point(size= 7, pch= 22, col= "black", aes(fill= treatment), position= position_jitter(width=0.1, height=0))+
  scale_fill_manual(values= treat.colors)+
  scale_color_manual(values= treat.colors)+
  ylab("Phosphorus mg/Kg")+
  xlab("")+
  theme_classic2()+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5))+
  scale_x_discrete(labels= treat.labels)+
  guides(fill=guide_legend(title="Treatment"))+
  stat_summary(fun=mean, aes(x= treatment, y = phosphorus),
               geom= "crossbar",  width=0.5, colour= "grey20", data=avgpho)+
  geom_text(data=tukey_phosphorus, aes(x=treatment, y = phosphorus, label= groups), 
            colour="black", nudge_x= 0.2, nudge_y= 3)+
  labs(title = "", subtitle = "", caption = "Different letters indicate statistically significant differences between each treatment at t4.\nCrossbar indicate the average of the three samples", size = 10 )+
  ggtitle("Phosphorus T4", subtitle= paste("ANOVA (HSDTukey) p-value: ", format(pvalue_anova_phospht4, scientific= TRUE, digits=2 ), sep= ""))+
  theme(
    plot.title = element_text(size = 11),
    plot.subtitle = element_text(size = 10),
    plot.caption = element_text(size = 8))
plot_phosphorus_t4
ggsave(plot_phosphorus_t4, file="soil_parameters_result/phosphorus_t4.png", width= 1900,height= 1200, units= "px")
```



```{r stats ph water t4, echo=FALSE}
shapiro.test(soilt4$ph.water) #no normal data
soil_prop %>% group_by(treatment) %>% shapiro_test(ph.water) #no normal all treatments except one

soilt4$log_ph.water <- log2(soilt4$ph.water) #transformation
shapiro.test(soilt4$log_ph.water)
soilt4 %>% group_by(treatment) %>% shapiro_test(log_ph.water)
soil_prop$log_ph.water <- log2(soil_prop$ph.water)#transformation
soil_prop %>% group_by(treatment) %>% shapiro_test(log_ph.water)#all the treatments are normal except one
soilt4$sqrt_ph.water <- sqrt(soilt4$ph.water)
shapiro.test(soilt4$sqrt_ph.water)
soilt4 %>% group_by(treatment) %>% shapiro_test(sqrt_ph.water)
soil_prop$sqrt_ph.water <- sqrt(soil_prop$ph.water)
soil_prop %>% group_by(treatment) %>% shapiro_test(sqrt_ph.water)#all the treatments are normal except one
soilt4$inv_ph.water <- 1/(soilt4$ph.water)
shapiro.test(soilt4$inv_ph.water)
soilt4 %>% group_by(treatment) %>% shapiro_test(inv_ph.water)
soil_prop$inv_ph.water <- 1/(soil_prop$ph.water)#transformation
soil_prop %>% group_by(treatment) %>% shapiro_test(inv_ph.water)#all the treatments are normal except one
soilt4$sum_ph.water <- 1+(soilt4$ph.water)
shapiro.test(soilt4$sum_ph.water)
soilt4 %>% group_by(treatment) %>% shapiro_test(sum_ph.water)
soil_prop$sum_ph.water <- 1+(soil_prop$ph.water)#transformation
soil_prop %>% group_by(treatment) %>% shapiro_test(sum_ph.water)#all the treatments are normal except one
soilt4$mul_ph.water <- 3*(soilt4$ph.water)
shapiro.test(soilt4$mul_ph.water)
soilt4 %>% group_by(treatment) %>% shapiro_test(mul_ph.water)
soil_prop$mul_ph.water <- 3*(soil_prop$ph.water)#transformation
soil_prop %>% group_by(treatment) %>% shapiro_test(mul_ph.water)#all the treatments are normal except one


anova_phwatert4 <- aov(sqrt_ph.water ~ treatment, data=soilt4)
anova_phwatert4<- summary(aov(sqrt_ph.water ~ treatment, data=soilt4))
pvalue_anova_phwatert4<- anova_phwatert4[[1]][["Pr(>F)"]][1]
tukey_phwatert4 <- HSD.test(aov(sqrt_ph.water ~ treatment, data=soilt4), "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")
tukey_phwatert4

avgphwatert4 <- aggregate(sqrt_ph.water ~ treatment, data=soilt4, FUN= mean)
avgphwatert4
soilt4$sqrt_ph.water
plot_phwater_t4 <- soilt4 %>% ggplot(aes(x= factor(treatment, level= treat.order), y= sqrt_ph.water, fill=treatment))+
  geom_point(size= 7, pch= 22, col= "black", aes(fill= treatment), position= position_jitter(width=0.1, height=0))+
  scale_color_manual(values= treat.colors)+
  scale_fill_manual(values= treat.colors)+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5))+
  scale_x_discrete(labels= treat.labels)+
  guides(fill=guide_legend(title="Treatment"))+
  ylab("pH water udes.")+
  xlab("")+
  theme_classic2()+
  stat_summary(fun=mean, aes(x= treatment, y = sqrt_ph.water),
               geom= "crossbar",  width=0.5, colour= "grey20", data=avgphwatert4)+
  geom_text(data=tukey_phwatert4, aes(x=treatment, y = sqrt_ph.water, label= groups), 
            colour="black", nudge_x= 0.2, nudge_y= 0.01)+
  labs(title = "", subtitle = "", caption = "Different letters indicate statistically significant differences between each treatment at t4.\nCrossbar indicate the average of the three samples", size = 10)+
  ggtitle("pH water T4", subtitle= paste("Data transformed. ANOVA (HSDTukey) p-value: ", format(pvalue_anova_phwatert4, scientific= TRUE, digits=2 ), sep= ""))+
  theme(
    plot.title = element_text(size = 11),
    plot.subtitle = element_text(size = 10),
    plot.caption = element_text(size = 8))
plot_phwater_t4
ggsave(plot_phwater_t4, file="soil_parameters_result/phwater_t4.png", width= 1900,height= 1200, units= "px")

```

```{r stats conductivity t4, include=FALSE}
shapiro.test(soilt4$conductivity) #no normal data
soil_prop %>% group_by(treatment) %>% shapiro_test(conductivity) # no normal
soilt4$log_conductivity <- log10(soilt4$conductivity)#transformation 
shapiro.test(soilt4$log_conductivity)#transformation
soilt4 %>% group_by(treatment) %>% shapiro_test(log_conductivity)#transformation
soil_prop$log_conductivity <- log10(soil_prop$conductivity)#transformation
shapiro.test(soil_prop$conductivity)#transformation
soilt4$sqrt_conductivity <- sqrt(soilt4$conductivity)#transformation
shapiro.test(soilt4$sqrt_conductivity)#transformation
soilt4 %>% group_by(treatment) %>% shapiro_test(sqrt_conductivity)#transformation
shapiro.test(soil_prop$sqrt_conductivity)#transformation
soil_prop %>% group_by(treatment) %>% shapiro_test(sqrt_conductivity) #all normal 
leveneTest(sqrt_conductivity~ treatment, data=soilt4) #equal variances 

anova_conductivityt4 <- aov(sqrt_conductivity ~ treatment, data=soilt4) #sig. different
anova_conductivityt4<- summary(aov(sqrt_conductivity ~ treatment, data=soilt4))
pvalue_anova_conductivityt4<- anova_conductivityt4[[1]][["Pr(>F)"]][1]
tukey_conductivityt4 <- HSD.test(aov(sqrt_conductivity ~ treatment, data=soilt4), "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")
tukey_conductivityt4
avgconduct4 <- aggregate(sqrt_conductivity ~ treatment, data=soilt4, FUN= mean)
plot_conduc_t4 <- soilt4 %>% ggplot(aes(x= factor(treatment, level= treat.order), y= sqrt_conductivity, fill=treatment))+
  geom_point(size= 7, pch= 22, col= "black", aes(fill= treatment), position= position_jitter(width=0.1, height=0))+
  scale_color_manual(values= treat.colors)+
  scale_fill_manual(values= treat.colors)+
  ylab("Conductivity mS/cm.")+
  xlab("")+
  scale_x_discrete(labels= treat.labels)+
  theme_classic2()+
  stat_summary(fun=mean, aes(x= treatment, y = sqrt_conductivity),
               geom= "crossbar", width=0.6, colour= "black", data=avgconduct4)+
  geom_text(data=tukey_conductivityt4, aes(x=treatment, y = sqrt_conductivity, label= groups), color="black", nudge_x= 0.2, nudge_y= 0.03)+
  labs(title = "", subtitle = "", caption = "Different letters indicate statistically significant differences between each treatment at t4.\nCrossbar indicate the average of the three samples", size = 10)+
  ggtitle("Conductivity T4", subtitle= paste("Data transformed. ANOVA (HSDTukey) p-value: ", format(pvalue_anova_conductivityt4, scientific= TRUE, digits=2 ), sep= ""))+
  guides(fill=guide_legend(title="Treatment"))+
  theme(
    plot.title = element_text(size = 11),
    plot.subtitle = element_text(size = 10),
    plot.caption = element_text(size = 8))

plot_conduc_t4
ggsave(plot_conduc_t4, file="soil_parameters_result/plot_conduc_t4.png", width= 1900,height= 1200, units= "px")
```


```{r stats calcium t4, echo=FALSE}
shapiro.test(soilt4$calcium) #normal data
leveneTest(calcium~ treatment, data=soilt4) # equal variances 
anova_calciumt4 <- aov(calcium ~ treatment, data=soilt4) #sig. different
anova_calciumt4<- summary(aov(calcium ~ treatment, data=soilt4))
pvalue_anova_calciumt4<- anova_calciumt4[[1]][["Pr(>F)"]][1]

tukey_calciumt4 <- HSD.test(aov(calcium ~ treatment, data=soilt4), "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")

avgcalciumt4 <- aggregate(calcium ~ treatment, data=soilt4, FUN= mean)
plot_calcium_t4 <- soilt4 %>% ggplot(aes(x= factor(treatment, level= treat.order), y= calcium, fill=treatment))+
  geom_point(size= 7, pch= 22, col= "black", aes(fill= treatment), position= position_jitter(width=0.1, height=0))+
  scale_color_manual(values= treat.colors)+
  scale_fill_manual(values= treat.colors)+
  ylab("Calcium mEq/kg.")+
  xlab("")+
  scale_x_discrete(labels= treat.labels)+
  theme_classic2()+
  stat_summary(fun=mean, aes(x= treatment, y = calcium),
               geom= "crossbar", width=0.6, colour= "black", data=avgcalciumt4)+
  geom_text(data=tukey_calciumt4, aes(x=treatment, y = calcium, label= groups), color="black", nudge_x= 0.2, nudge_y= 3)+
  labs(title = "", subtitle = "", caption = "Different letters indicate statistically significant differences between each treatment at t4.\nCrossbar indicate the average of the three samples", size = 10)+
  ggtitle("Calcium T4", subtitle= paste("ANOVA (HSDTukey) p-value: ", format(pvalue_anova_calciumt4, scientific= TRUE, digits=2 ), sep= ""))+
  guides(fill=guide_legend(title="Treatment"))+
  theme(
    plot.title = element_text(size = 11),
    plot.subtitle = element_text(size = 10),
    plot.caption = element_text(size = 8))
plot_calcium_t4
ggsave(plot_calcium_t4, file="soil_parameters_result/plot_calcium_t4.png", width= 1900,height= 1200, units= "px")
```


```{r stats sodium t4, echo=FALSE}
shapiro.test(soilt4$sodium) #normal data
leveneTest(sodium~ treatment, data=soilt4) # equal variances 

anova_sodiumt4 <- aov(sodium ~ treatment, data=soilt4) #sig. different
anova_sodiumt4<- summary(aov(sodium ~ treatment, data=soilt4))
pvalue_anova_sodiumt4<- anova_sodiumt4[[1]][["Pr(>F)"]][1]

tukey_sodiumt4 <- HSD.test(aov(sodium ~ treatment, data=soilt4), "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")
avgsodiumt4 <- aggregate(sodium~ treatment, data=soilt4, FUN= mean)

plot_sodium_t4 <- soilt4 %>% ggplot(aes(x= factor(treatment, level= treat.order), y= sodium, col=treatment))+
  geom_point(size= 7, pch= 22, col= "black", aes(fill= treatment), position= position_jitter(width=0.1, height=0))+
  scale_color_manual(values= treat.colors)+
  scale_fill_manual(values= treat.colors)+
  ylab("sodium mEq/kg.")+
  xlab("")+
  scale_x_discrete(labels= treat.labels)+
  theme_classic2()+
  stat_summary(fun=mean, aes(x= treatment, y = sodium),
               geom= "crossbar", width=0.6, colour= "black", data=avgsodiumt4)+
  geom_text(data=tukey_sodiumt4, aes(x=treatment, y = sodium, label= groups), color="black", nudge_x= 0.2, nudge_y= 0.5)+
  labs(title = "", subtitle = "", caption = "Different letters indicate statistically significant differences between each treatment at t4.\nCrossbar indicate the average of the three samples", size = 10)+
  ggtitle("Sodium T4", subtitle= paste("ANOVA (HSDTukey) p-value: ", format(pvalue_anova_sodiumt4, scientific= TRUE, digits=2 ), sep= ""))+
  guides(fill=guide_legend(title="Treatment"))+
  theme(
    plot.title = element_text(size = 11),
    plot.subtitle = element_text(size = 10),
    plot.caption = element_text(size = 8))
plot_sodium_t4
ggsave(plot_sodium_t4, file="soil_parameters_result/plot_sodium_t4.png", width= 1900,height= 1200, units= "px")
```


```{r stats potassium t4, echo=FALSE}
shapiro.test(soilt4$potassium) #no normal data
soilt4 %>% group_by(treatment) %>% shapiro_test(potassium) # each treatments are normal 
leveneTest(potassium~ treatment, data=soilt4) # equal variances 
anova_potassiumt4 <- aov(potassium ~ treatment, data=soilt4) #sig. different
anova_potassiumt4<- summary(aov(potassium ~ treatment, data=soilt4))
pvalue_anova_potassiumt4<- anova_potassiumt4[[1]][["Pr(>F)"]][1]


tukey_potassiumt4 <- HSD.test((aov(potassium ~ treatment, data=soilt4)), "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")
avgpotassiumt4 <- aggregate(potassium~ treatment, data=soilt4, FUN= mean)

plot_potassium_t4 <- soilt4 %>% ggplot(aes(x= factor(treatment, level= treat.order), y= potassium, col=treatment))+
  geom_point(size= 7, pch= 22, col= "black", aes(fill= treatment), position= position_jitter(width=0.1, height=0))+
  scale_color_manual(values= treat.colors)+
  scale_fill_manual(values= treat.colors)+
  ylab("potassium mEq/kg.")+
  xlab("")+
  scale_x_discrete(labels= treat.labels)+
  theme_classic2()+
  stat_summary(fun=mean, aes(x= treatment, y = potassium),
               geom= "crossbar", width=0.6, colour= "black", data=avgpotassiumt4)+
  geom_text(data=tukey_potassiumt4, aes(x=treatment, y = potassium, label= groups), color="black", nudge_x= 0.2, nudge_y= 0.5)+
  labs(title = "", subtitle = "", caption = "Different letters indicate statistically significant differences between each treatment at t4.\nCrossbar indicate the average of the three samples", size = 10)+
  ggtitle("Potassium T4", subtitle= paste("ANOVA (HSDTukey) p-value: ", format(pvalue_anova_potassiumt4, scientific= TRUE, digits=2 ), sep= ""))+
  guides(fill=guide_legend(title="Treatment"))+
  theme(
    plot.title = element_text(size = 11),
    plot.subtitle = element_text(size = 10),
    plot.caption = element_text(size = 8))

plot_potassium_t4
ggsave(plot_potassium_t4, file="soil_parameters_result/plot_potassium_t4.png", width= 1900,height= 1200, units= "px")
```

```{r stats nitrogent4, echo=FALSE}
shapiro.test(soilt4$nitrogen) #normal data
leveneTest(nitrogen~ treatment, data=soilt4) # equal variances 

anova_nitrogent4 <- aov(nitrogen ~ treatment, data=soilt4) #sig. different
anova_nitrogent4<- summary(aov(nitrogen ~ treatment, data=soilt4))
pvalue_anova_nitrogent4<- anova_nitrogent4[[1]][["Pr(>F)"]][1]

tukey_nitrogent4 <- HSD.test((aov(nitrogen ~ treatment, data=soilt4)), "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")

avgnitrogent4 <- aggregate(nitrogen~ treatment, data=soilt4, FUN= mean)

plot_nitrogen_t4 <- soilt4 %>% ggplot(aes(x= factor(treatment, level= treat.order), y= nitrogen, fill=treatment))+
  geom_point(size= 7, pch= 22, col= "black", aes(fill= treatment), position= position_jitter(width=0.1, height=0))+
  scale_color_manual(values= treat.colors)+
  scale_fill_manual(values= treat.colors)+
  ylab("nitrogen (%).")+
  xlab("")+
  scale_x_discrete(labels= treat.labels)+
  theme_classic2()+
  stat_summary(fun=mean, aes(x= treatment, y = nitrogen),
               geom= "crossbar", width=0.6, colour= "black", data=avgnitrogent4)+
  geom_text(data=tukey_nitrogent4, aes(x=treatment, y = nitrogen, label= groups), color="black", nudge_x= 0.2, nudge_y= 0.01)+
  labs(title = "", subtitle = "", caption = "Different letters indicate statistically significant differences between each treatment at t4.\nCrossbar indicate the average of the three samples", size = 10)+
  ggtitle("Nitrogen T4", subtitle= paste("ANOVA (HSDTukey) p-value: ", format(pvalue_anova_nitrogent4, scientific= TRUE, digits=2 ), sep= ""))+
  guides(fill=guide_legend(title="Treatment"))+
  theme(
    plot.title = element_text(size = 11),
    plot.subtitle = element_text(size = 10),
    plot.caption = element_text(size = 8))

plot_nitrogen_t4
ggsave(plot_nitrogen_t4, file="soil_parameters_result/plot_nitrogen_t4.png", width= 1900,height= 1200, units= "px")
```

### PCA


```{r pca, echo=TRUE}
#PCA reducir la dimensionalidad de los datos. Componetes=dimensiones. Simplificar la complejidad en conjuntos de datos grandes.  Es una técnica de reducción de dimensionalidad que transforma los datos originales en un conjunto nuevo de variables (los componentes principales) que son no correlacionadas y que explican la mayor cantidad posible de la varianza total. Si la varianza es mayor, es el dato que mas varia.
#Hay que escalar y centrar los datos primero. (prcomp(resta la media de cada una de las varibles), scale(desviacion tipica)) para reducir la variabilidad de todas las muestras
#PAra elegir las componentes, ver en plot(data, type"l")lo que forme un codo. Summary(dta)Elegir por ejemplo hasta explicar 80% en cumalative proportion. *Explicar con la variacion de los datos que tengo*

soil_prop_pca <- data.frame(soil_prop)
soil_prop_pca$soil.id<- NULL
soil_prop_pca$rep<-NULL
soil_prop_pca
info_soil <- soil_prop_pca[, c(1:2)]

numeric_col_soil<-  sapply(soil_prop_pca, is.numeric)#hay que separar los numeros del texto. solo pueden tener valores numericos 
pca_soil_data <- scale(soil_prop_pca[, numeric_col_soil]) #nos lo ha escalado (ajustado la desviacion tipica)

pca_soil_result <- prcomp(pca_soil_data, center = TRUE, scale. = TRUE) #escalado y centrado de los datos
summary(pca_soil_result)
pca_soil_result
# Visualización de la proporción de varianza explicada
plot(pca_soil_result, type = "l")

pca_scores <- pca_soil_result$x %>% data.frame()#guardamos resultados de cada caponente en nuevo dataframe
pca_soil <- data.frame(pca_scores,info_soil)# y unimos con la informacion de cada valor 


valores_acumulativos <- summary(pca_soil_result)$importance
valor_PC1<- valores_acumulativos[3, 1]
valor_PC1
valor_PC2<-valores_acumulativos[3, 2]

plot_pca <- pca_soil  %>% ggplot(aes(PC1, PC2, colour= treatment, shape= time))+
  geom_point(size=3)+
  xlab(paste("PCA1 (", sprintf("%.2f%%", valor_PC1 * 100), ")")) +  # para add % acumulativo
  ylab(paste("PCA2 (", sprintf("%.2f%%", valor_PC2 * 100), ")"))+
  labs(title = "PCA soil properties", subtitle= "4 sampling times")+
  scale_fill_manual(values=treat.colors)+
  scale_color_manual(values=treat.colors)+
  geom_polygon(aes(fill =  treatment, group = interaction(time, treatment)),alpha= 0.5)+
  guides(guides(
    color = guide_legend(title = "Treatment"),
    shape = guide_legend(title = "Time"),
    fill = guide_legend(title = "Treatment")
  ))+
  theme_bw()
plot_pca
ggsave(plot_pca, file="soil_parameters_result/plot_pca_soil.png", width= 1900,height= 1200, units= "px")


#stat_ellipse(aes(group= interaction(treatment,time), col= treatment))+
  #stat_ellipse(aes(group = treatment, fill = treatment), geom = "polygon", alpha = 0.2, linetype = 2)+
#stat_ellipse(aes(group= interaction(treatment,time), col= treatment))
 #geom_polygon(aes(group= interaction(treatment, time), fill= treatment, alpha= time))

###pca de t0 y t4 ###
soil_prop_pca_t0t4 <- soil_prop_pca %>% filter(time == "t0" | time == "t4")
info_soilt0t4 <- soil_prop_pca_t0t4[, c(1:2)]

numeric_col_soilt0t4<-  sapply(soil_prop_pca_t0t4, is.numeric)#hay que separar los numeros del texto. solo pueden tener valores numericos 
pca_soil_datat0t4 <- scale(soil_prop_pca_t0t4[, numeric_col_soilt0t4])

pca_soil_t0t4 <- prcomp(pca_soil_datat0t4, center = TRUE, scale. = TRUE) 
summary(pca_soil_t0t4)
pca_soil_t0t4

plot(pca_soil_t0t4, type = "l")

pca_scorest0t4 <- pca_soil_t0t4$x %>% data.frame()
pca_soilt0t4 <- data.frame(pca_scorest0t4,info_soilt0t4)# y unimos con la informacion de cada valor 

valores_acumulativost0t4 <- summary(pca_soil_t0t4)$importance
valor_PC1t0t4<- valores_acumulativost0t4[3, 1]
valor_PC2t0t4<-valores_acumulativost0t4[3, 2]

plot_pcat0t4 <- pca_soilt0t4  %>% ggplot(aes(PC1, PC2, colour= treatment, shape= time))+
  geom_point(size=3)+
  xlab(paste("PCA1 (", sprintf("%.2f%%", valor_PC1t0t4 * 100), ")")) +  
  ylab(paste("PCA2 (", sprintf("%.2f%%", valor_PC2t0t4 * 100), ")"))+
  labs(title = "PCA soil properties", subtitle= "4 sampling times")+
  scale_fill_manual(values=treat.colors)+
  scale_color_manual(values=treat.colors)+
  #geom_polygon(aes(fill =  time, group = interaction(time, treatment)),alpha= 0.5)+
  guides(guides(
    color = guide_legend(title = "Treatment"),
    shape = guide_legend(title = "Time"),
    fill = guide_legend(title = "Time")
  ))+
  scale_shape_manual(values=c(1,16))+
   theme_bw()+
  stat_ellipse(aes(group =time, fill= time), level = 0.95, geom = "polygon", alpha = 0.2)
plot_pcat0t4
ggsave(plot_pcat0t4, file="soil_parameters_result/pca_t0t4.png", width= 1900,height= 1200, units= "px")

```

