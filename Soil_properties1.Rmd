---
title: "Banana project, organic matter-microbiome"
output: html_document
date: "`r Sys.Date()`"
---

```{r, include=FALSE}
library(ggplot2)
library(tidyverse)
library(ggpubr)
library(gridExtra)
library(corrplot)
library(agricolae)
library(emmeans)
library(multcomp)
library(multcompView)
library(data.table)
library(tidyverse)
library(phyloseq)
library(vegan)
library(ape)
library(here)
library(readxl)
library(ggpubr)
library(geomtextpath)
library(knitr)
library(gridExtra)
library(Biostrings)
library(seqinr)
library(FSA)
library(agricolae)
library(MASS)
library(grid)
library(gridExtra)
library(emmeans)
library(multcomp)
library(broom)
library(viridis)
library(ALDEx2)
library(FactoMineR)
library(factoextra)
library(kableExtra)
library(scales)
library(dunn.test)
library(car)
library(corrplot)
library(eulerr)
library(ggforce)
library(ggrepel)
```


# Analisis de datos octubre 2023


```{r Palette, include= FALSE}

banana.paleta = list(
  paleta.treat = c("#FFC125", "#8B7D6B", "#81bc1f", "#ddec76",
                 "#a4e361", "#27408B", "#EE5C42"),
  my_favourite_colours = c("#702963", "#637029",    "#296370"))


banana.paleta.f = function(name, n, all_palettes = banana.paleta, type = c("discrete", "continuous")) {
  palette = all_palettes[[name]]
  if (missing(n)) {
    n = length(palette)
  }
  type = match.arg(type)
  out = switch(type,
               continuous = grDevices::colorRampPalette(palette)(n),
               discrete = palette[1:n] )
  structure(out, name = name, class = "palette")
}
banana.paleta.f("paleta.treat", all_palettes = banana.paleta, type= "discrete")

scale_colour_banana_disc = function(name) {
  ggplot2::scale_colour_manual(values = banana.paleta.f(name, type = "discrete"))
}

scale_fill_banana_disc = function(name) {
  ggplot2::scale_fill_manual(values = banana.paleta.f(name,
                                                     type = "discrete"))
}

```

## Propidedades del suelo

Esto se ha hecho para cargar el Excel de los datos iniciales (ojo, para poner el directorio de donde esta tu archivo excel, se tiene que cambiar \, por /), y para hacer la media de cada tratamiento, ya que de cada tratamiento hay 3 repeticiones. El simbolo %>% se llaman tuberias (the pipe) vienen de la libreria (tinyverse) (esta libreria sirve para mantener R m치s ordenado). Las tuberias funcionan usando el resultado de una operaci칩n(out) y convirtiendolo en el imput de otra. En el caso del codigo  "soil.summ <- soil_prop %>% group_by(treatment,  time) %>% summarise(across(.cols=everything(), .fns=mean),.groups = "drop")" quiere decir lo siguiente: hemos creado un objeto nuevo que es soil.summ, que es_ el archivo de excel soil_prop el que hacemos una serie de operaciones en cadena (tuberia) donde agrupamos solamente por tratamiento y tiempo (group_by,) y en ese agrupamiento queremos de todas las columnas, .cols=every, que haga la funcion de la media (fns=mean). NULL significa que no tenga en cuenta esas columnas. $ es para seleccionar cosas especificas. 
```{r Import, include=TRUE}
soil_prop <- readxl::read_excel("C:/Users/raquel.correa/Documents/banana_microbiome/raw_files/soil_prop_2.xlsx")

soil.summ <- soil_prop %>% group_by(treatment,  time) %>% 
  summarise(across(.cols=everything(),.fns=mean),.groups = "drop")

soil.summ

soil.summ$rep <- NULL
soil.summ$soil.id <- NULL

```

### Evolucion de cada parametros en los distintos muestreos del experimento

En este codigo veremos la evolucion de los distintos parametros en el tiempo. 
La funci칩n "aes" sirve para indicar en un grafico cual es tu X,y. Debes indicar en texto quien es quien.Toda la informaci칩n de los datos referido al grafico es lo que va dentro del parentesis. Los adornos van fuera con el signo de +. La funcion "geom_line" sirve para elegir el tipo de grafico que quieres. 

```{r Materia organica plot, include= TRUE}
org.mat.plotsd <- soil.summ.sd%>% ggplot(aes(x=time, group= treatment, col= treatment, y= org.matter_mean))+
  geom_line()+
  scale_colour_banana_disc("paleta.treat")+
  geom_point()+
  geom_errorbar(aes(ymin=org.matter_mean-org.matter_sd, ymax=org.matter_mean+org.matter_sd), width=0.2)
org.mat.plotsd
 

```
![Figure 1: organic matter over time in diffrerent treatments.]

```{r Fosforo plot, include=FALSE}
phosp.plotsd <- soil.summ.sd%>% ggplot(aes(x=time, group= treatment, col= treatment, y=phosphorus_mean))+
  geom_line()+
  scale_colour_banana_disc("paleta.treat")+
  geom_point()+
  geom_errorbar(aes(ymin=phosphorus_mean-phosphorus_sd, ymax=phosphorus_mean+phosphorus_sd), width=0.2)

phosp.plotsd

```
![Figure 2: phosphorous over time in different treatments.]

```{r Calcium plot, include=FALSE}

calcium.plotsd <- soil.summ.sd%>% ggplot(aes(x=time, group= treatment, col= treatment, y= calcium_mean))+
  geom_line()+
  scale_colour_banana_disc("paleta.treat")+
  geom_point()+
  geom_errorbar(aes(ymin=calcium_mean-calcium_sd, ymax=calcium_mean+calcium_sd), width=0.2)

calcium.plotsd




```
![Figure 3. calcium over time in different treatments.]

```{r sodium plot, include=FALSE}

sodium.plotsd <- soil.summ.sd%>% ggplot(aes(x=time, group= treatment, col= treatment, y= sodium_mean))+
  geom_line()+
  scale_colour_banana_disc("paleta.treat")+
  geom_point()+
  geom_errorbar(aes(ymin=sodium_mean-sodium_sd, ymax=sodium_mean+sodium_sd), width=0.2)

sodium.plotsd
```
![Figure 4: sodium over time in different treatments.]


```{r postassium plot, include=FALSE}
potassium.plotsd <- soil.summ.sd%>% ggplot(aes(x=time, group= treatment, col= treatment, y= potassium_mean))+
  geom_line()+
  scale_colour_banana_disc("paleta.treat")+
  geom_point()+
  geom_errorbar(aes(ymin=potassium_mean-potassium_sd, ymax=potassium_mean+potassium_sd), width=0.2)

potassium.plotsd

```
![Figure 5: potassium over time in different treatments.]


```{r pH agua plot, include=FALSE}

pH_water.plotsd <- soil.summ.sd%>% ggplot(aes(x=time, group= treatment, col= treatment, y= ph.water_mean))+
  geom_line()+
  scale_colour_banana_disc("paleta.treat")+
  geom_point()+
  geom_errorbar(aes(ymin=ph.water_mean-ph.water_sd, ymax=ph.water_mean+ph.water_sd), width=0.2)

pH_water.plotsd

```
![Figure 6: pH water over time in different treatments.]

```{r conductivity plot, include=FALSE}
conductivity.plotsd <- soil.summ.sd%>% ggplot(aes(x=time, group= treatment, col= treatment, y= conductivity_mean))+
  geom_line()+
  scale_colour_banana_disc("paleta.treat")+
  geom_point()+
  geom_errorbar(aes(ymin=conductivity_mean-conductivity_sd, ymax=conductivity_mean+conductivity_sd), width=0.2)

conductivity.plotsd

```
![Figure 7: conductivity over time in different treatments.]

```{r nitrogen plot, include=FALSE}
nitrogen.plotsd <- soil.summ.sd%>% ggplot(aes(x=time, group= treatment, col= treatment, y= nitrogen_mean))+
  geom_line()+
  scale_colour_banana_disc("paleta.treat")+
  geom_point()+
  geom_errorbar(aes(ymin=nitrogen_mean-nitrogen_sd, ymax=nitrogen_mean+nitrogen_sd), width=0.2)

nitrogen.plotsd

```
![Figure 8: nitrogen over time in different treatments.]


### Analisis estadistico.

## Materia organica 

Para comprobar si hay diferencias significativas o no. 
1.Dif. entre tratamientos y tiempos. 
2.Dif. entre 1 tratamiento a lo largo del tiempo. 
Vamos analizar diferencias en el primer muestreo (to), por ello usamos la funcion subset que es un condicional como simbolo de dolar o funcion subset, para elegir determinadas variables dentro de un objeto,  significa solo analizar del archivo soil_prop, la columan soil_prop$time que sea igual a t0)
Le hacemos un modelo de regresion lineal, o se puede analizar directamnte con anova. 


```{r Materia organica stats, include=TRUE}
soilt0 <- subset(soil_prop, soil_prop$time== "t0")


shapiro.test(soilt0$org.matter)#ahora vamos a comprobar la normalidad de los datos. Los datos no son normales. Hay que transformarlos. Lo haremos con log.

soilt0$trans.org <- log(soilt0$org.matter)

shapiro.test(soilt0$trans.org)#ahora si son normales. 
hist(soilt0$trans.org) #comprobamos con grafico
plot(soilt0$trans.org)
anova.org.matter.t0 <- aov(soilt0$trans.org~ treatment, data=soilt0)
summary(anova.org.matter.t0)
plot(anova.org.matter.t0, which=2)

#test de Levene para el analisis de la varianza
leveneTest(soilt0$trans.org~ treatment, data=soilt0)
## el valor de p es mayor que 0.05, se cumple el supuesto de homogenicidad de varianzas.


```


```{r Materia organica stats POST-HOC, include=TRUE}

#Puesto que hay direferencias sig. vamos a comprobar entre que tratamientos. POST-HOC.

#### hsd tuckey from agricolae::
hsd.t0.org <- HSD.test(anova.org.matter.t0, "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")

hsd.t0.org #preguntar ignacio como ver los resultados en un grafico

```
[!Diferencias sig. entre tratamients para t0. Los datos estan transformados con logaritmo]



```{r plot org t0}
#crear un grafico con la media de la los valores de materia organica de t0, y la letra de HSDTukey)
avgm <- aggregate(org.matter~ treatment, data= soilt0, FUN= mean)
plot.org.t0 <- soilt0 %>% ggplot(aes(x= treatment, y= org.matter))+
  geom_point()+
  stat_summary(fun=mean, aes(x= treatment, y= org.matter),
               geom= "crossbar", data=avgm)+
  geom_text(data=hsd.t0.org,aes(x=treatment, y= org.matter, label= groups), nudge_x= 0.2, nudge_y= 0.2)


plot.org.t0
```
Figura X. Diferencias significativas entre tratamientos en t0 para materia organica


###Phosphorus
```{r Phosphorous stats, include=TRUE}
soilt0
lm.t0.phosphorous <- lm(phosphorus~ treatment, data= soilt0)
anova.lm.t0.pho <- aov(lm.t0.phosphorous)
summary(anova.lm.t0.pho)

shapiro.test(soilt0$phosphorus) #LOS DATOS NO SON NORMALES. preguntar ignacio mejor forma para normalizar datos
ks.test(soilt0$phosphorus, pnorm)
soilt0$trans.phospo <- log(soilt0$phosphorus)             
shapiro.test(soilt0$trans.phospo)            
par(mfrow=c(2,2), cex.axis=1.5, lwd=2, font.lab=1.5)
plot(anova.lm.t0.pho)

hist(anova.lm.t0.pho$residuals)
plot(anova.lm.t0.pho, which=2)

leveneTest(phosphorus~ treatment, data= soilt0)
# el valor de p es mayor que 0.05, se cumple el supuesto de homogenicidad de varianzas.
```


```{r Phosphorus POST-HOC, include=TRUE}

#Puesto que hay direferencias sig. vamos a comprobar entre que tratamientos. POST-HOC.

#### hsd tuckey from agricolae::
hsd.t0.pho <- HSD.test(anova.lm.t0.pho, "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")

hsd.t0.pho

```

```{r plot phosphorus t0}

avgpho <- aggregate(phosphorus~ treatment, data= soilt0, FUN= mean)
plot.pho.t0 <- soilt0 %>% ggplot(aes(x= treatment, y= phosphorus))+
  geom_point()+
  stat_summary(fun=mean, aes(x= treatment, y= phosphorus),
               geom= "crossbar", data=avgpho)+
  geom_text(data=hsd.t0.pho,aes(x=treatment, y= phosphorus, label= groups), nudge_x= 0.2, nudge_y= 0.2)


plot.pho.t0
```
###ph water


```{r ph water stast, include=TRUE}
lm.t0.ph <- lm(ph.water~ treatment, data= soilt0)
anova.lm.t0.ph <- aov(lm.t0.ph)
summary(anova.lm.t0.ph)

shapiro.test(soilt0$ph.water) ##datos no normales xq sin hacer el anova, salen no normales y con el lm salen normales
ks.test(soilt0$ph.water, pnorm)
shapiro.test(anova.lm.t0.ph$residuals)
hist(soilt0$ph.water)
plot(soilt0$ph.water)

leveneTest(ph.water ~ treatment, data= soilt0) #varianzas diferentes

```

```{r Ph POST-HOC, include=TRUE}
#### hsd tuckey from agricolae::

hsd.t0.ph <- HSD.test(anova.lm.t0.ph, "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")

hsd.t0.ph
```

```{r plot ph_water t0, include=TRUE}
avgphwater <- aggregate(ph.water ~ treatment, data= soilt0, FUN= mean)

plot.phwater.t0 <- soilt0 %>% ggplot(aes(x= treatment, y=ph.water))+
  geom_point()+
  stat_summary(fun=mean, aes(x= treatment, y= ph.water),
               geom= "crossbar", data=avgphwater)+
  geom_text(data=hsd.t0.ph,aes(x=treatment, y= ph.water, label= groups), nudge_x= 0.2, nudge_y= 0.2)

plot.phwater.t0
```

###Conductivity

```{r conductivity stats, include=TRUE}
soilt0
lm.t0.conduc <- lm(conductivity~ treatment, data= soilt0)
anova.lm.t0.conduc <- aov(lm.t0.conduc)
summary(anova.lm.t0.conduc)

shapiro.test(soilt0$conductivity) #datos no normales
ks.test(soilt0$conductivity, pnorm)
             

hist(anova.lm.t0.conduc$residuals)
plot(anova.lm.t0.conduc, which=2)

leveneTest(conductivity~ treatment, data= soilt0)
# el valor de p es mayor que 0.05, se cumple el supuesto de homogenicidad de varianzas.}

```

```{r conductivity POST-HOC, include=TRUE}
#### hsd tuckey from agricolae::

hsd.t0.conduc <- HSD.test(anova.lm.t0.conduc, "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")

hsd.t0.conduc

```

```{r plot conductivity, include=TRUE}
avgconduc <- aggregate(conductivity ~ treatment, data= soilt0, FUN= mean)

plot.conduc.t0 <- soilt0 %>% ggplot(aes(x= treatment, y=conductivity))+
  geom_point()+
  stat_summary(fun=mean, aes(x= treatment, y= conductivity),
               geom= "crossbar", data=avgconduc)+
  geom_text(data=hsd.t0.conduc,aes(x=treatment, y= conductivity, label= groups), nudge_x= 0.2, nudge_y= 0.2)

plot.conduc.t0
```


```{r Correlogram, echo=FALSE}
soil_prop_cor <- soil_prop
soil_prop_cor$rep <- NULL
soil_prop_cor$soil.id <- NULL
soil_prop_cor$treatment <- NULL
soil_prop_cor$time <- NULL
cor.matrix <- soil_prop_cor %>% cor()

cor.mat.test <- cor.mtest(cor.matrix)

corrplot(cor.matrix, p.mat=cor.mat.test$p, sig.level = 0.05, order= "hclust", type= "upper", method= "number", insig = "pch", pch=4,number.cex = 0.75)
```

The most interesing variables seem to be pH.water, organic matter, conductivity and NPKCa values. The rest could be omitted. 

