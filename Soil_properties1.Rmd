---
title: "Banana project, organic matter-microbiome"
output: html_document
date: "`r Sys.Date()`"
---

```{r, include=FALSE}
library(ggplot2)
library(tidyverse)
library(ggpubr)
library(gridExtra)
library(corrplot)
library(agricolae)
library(emmeans)
library(multcomp)
library(multcompView)
library(data.table)
library(tidyverse)
library(phyloseq)
library(vegan)
library(ape)
library(here)
library(readxl)
library(ggpubr)
library(geomtextpath)
library(knitr)
library(gridExtra)
library(Biostrings)
library(seqinr)
library(FSA)
library(agricolae)
library(MASS)
library(grid)
library(gridExtra)
library(emmeans)
library(multcomp)
library(broom)
library(viridis)
library(ALDEx2)
library(FactoMineR)
library(factoextra)
library(kableExtra)
library(scales)
library(dunn.test)
library(car)
library(corrplot)
library(eulerr)
library(ggforce)
library(ggrepel)
library(rstatix)
library(AICcmodavg)
library(ggthemes)

```


# Data analysis octubre 2023


```{r Palette, include= FALSE}

banana.paleta = list(
  paleta.treat = c("#FFC125", "#8B7D6B", "#81bc1f", "#ddec76",
                 "#a4e361", "#27408B", "#EE5C42"),
  my_favourite_colours = c("#702963", "#637029",    "#296370"),
  paleta.iro= c("royalblue4","darkolivegreen","darkseagreen","darkolivegreen3","darkred","darkorchid"))


banana.paleta.f = function(name, n, all_palettes = banana.paleta, type = c("discrete", "continuous")) {
  palette = all_palettes[[name]]
  if (missing(n)) {
    n = length(palette)
  }
  type = match.arg(type)
  out = switch(type,
               continuous = grDevices::colorRampPalette(palette)(n),
               discrete = palette[1:n] )
  structure(out, name = name, class = "palette")
}
banana.paleta.f("paleta.treat", all_palettes = banana.paleta, type= "discrete")

scale_colour_banana_disc = function(name) {
  ggplot2::scale_colour_manual(values = banana.paleta.f(name, type = "discrete"))
}

scale_fill_banana_disc = function(name) {
  ggplot2::scale_fill_manual(values = banana.paleta.f(name,
                                                     type = "discrete"))
}

```


```{r colors, include=FALSE}
treat.colors <- c("control"= "green4" ,"control.amf"  = "darkseagreen" , "chicken.manure"= "royalblue1", "cow.manure" = "red3","mo.pellet"= "darkorchid1","compost"="chocolate4","control.legumes"="darkolivegreen4")
treat.colors

```

## Properties of soil 


```{r Import, include=FALSE}
#Esto se ha hecho para cargar el Excel de los datos iniciales (ojo, para poner el directorio de donde esta tu archivo excel, se tiene que cambiar \, por /), y para hacer la media de cada tratamiento, ya que de cada tratamiento hay 3 repeticiones. El simbolo %>% se llaman tuberias (the pipe) vienen de la libreria (tinyverse) (esta libreria sirve para mantener R m치s ordenado). Las tuberias funcionan usando el resultado de una operaci칩n(out) y convirtiendolo en el imput de otra. En el caso del codigo  "soil.summ <- soil_prop %>% group_by(treatment,  time) %>% summarise(across(.cols=everything(), .fns=mean),.groups = "drop")" quiere decir lo siguiente: hemos creado un objeto nuevo que es soil.summ, que es_ el archivo de excel soil_prop el que hacemos una serie de operaciones en cadena (tuberia) donde agrupamos solamente por tratamiento y tiempo (group_by,) y en ese agrupamiento queremos de todas las columnas, .cols=every, que haga la funcion de la media (fns=mean). NULL significa que no tenga en cuenta esas columnas. $ es para seleccionar cosas especificas. 

soil_prop <- readxl::read_excel("C:/Users/raquel.correa/Documents/banana_microbiome/raw_files/soil_prop_2.xlsx")

soil.summ <- soil_prop %>% group_by(treatment,  time) %>% 
  summarise(across(.cols=everything(),.fns=mean),.groups = "drop")

soil.summ.sd <- soil_prop %>% group_by(treatment,  time) %>% 
  summarise(across(.cols=everything(),.fns=list(mean = mean, sd = sd)),.groups = "drop")

soil.summ$rep <- NULL
soil.summ$soil.id <- NULL

```

### Evolucion de cada parametros en los distintos muestreos del experimento


```{r over the time, include=FALSE}

#En este codigo veremos la evolucion de los distintos parametros en el tiempo. La funci칩n "aes" sirve para indicar en un grafico cual es tu X,y. Debes indicar en texto quien es quien.Toda la informaci칩n de los datos referido al grafico es lo que va dentro del parentesis. Los adornos van fuera con el signo de +. La funcion "geom_line" sirve para elegir el tipo de grafico que quieres. 


org.mat.plotsd <- soil.summ.sd%>% ggplot(aes(x=time, group= treatment, col= treatment, y= org.matter_mean))+
  geom_line()+
  theme_classic()+
  xlab("")+
  ylab("Organic matter")+
  scale_color_manual(values= treat.colors)+
  geom_point()+
  geom_errorbar(aes(ymin=org.matter_mean-org.matter_sd, ymax=org.matter_mean+org.matter_sd), width=0.2)
org.mat.plotsd

phosp.plotsd <- soil.summ.sd%>% ggplot(aes(x=time, group= treatment, col= treatment, y=phosphorus_mean))+
  geom_line()+
  theme_classic()+
  xlab("")+
  ylab("Phosphorus")+
  scale_color_manual(values= treat.colors)+
  geom_point()+
  geom_errorbar(aes(ymin=phosphorus_mean-phosphorus_sd, ymax=phosphorus_mean+phosphorus_sd), width=0.2)
phosp.plotsd

calcium.plotsd <- soil.summ.sd%>% ggplot(aes(x=time, group= treatment, col= treatment, y= calcium_mean))+
  geom_line()+
  theme_classic()+
  xlab("")+
  ylab("Calcium")+
  scale_color_manual(values= treat.colors)+
  geom_point()+
  geom_errorbar(aes(ymin=calcium_mean-calcium_sd, ymax=calcium_mean+calcium_sd), width=0.2)
calcium.plotsd

sodium.plotsd <- soil.summ.sd%>% ggplot(aes(x=time, group= treatment, col= treatment, y= sodium_mean))+
  geom_line()+
  theme_classic()+
  xlab("")+
  ylab("Sodium")+
  scale_color_manual(values= treat.colors)+
  geom_point()+
  geom_errorbar(aes(ymin=sodium_mean-sodium_sd, ymax=sodium_mean+sodium_sd), width=0.2)
sodium.plotsd

potassium.plotsd <- soil.summ.sd%>% ggplot(aes(x=time, group= treatment, col= treatment, y= potassium_mean))+
  geom_line()+
  theme_classic()+
  xlab("")+
  ylab("Potassium")+
  scale_color_manual(values= treat.colors)+
  geom_point()+
  geom_errorbar(aes(ymin=potassium_mean-potassium_sd, ymax=potassium_mean+potassium_sd), width=0.2)
potassium.plotsd

pH_water.plotsd <- soil.summ.sd%>% ggplot(aes(x=time, group= treatment, col= treatment, y= ph.water_mean))+
  geom_line()+
  theme_classic()+
  xlab("")+
  ylab("pH water")+
  scale_color_manual(values= treat.colors)+
  geom_point()+
  geom_errorbar(aes(ymin=ph.water_mean-ph.water_sd, ymax=ph.water_mean+ph.water_sd), width=0.2)
pH_water.plotsd

conductivity.plotsd <- soil.summ.sd%>% ggplot(aes(x=time, group= treatment, col= treatment, y= conductivity_mean))+
  geom_line()+
  theme_classic()+
  xlab("")+
  ylab("Conductivity")+
  scale_color_manual(values= treat.colors)+
  geom_point()+
  geom_errorbar(aes(ymin=conductivity_mean-conductivity_sd, ymax=conductivity_mean+conductivity_sd), width=0.2)
conductivity.plotsd

nitrogen.plotsd <- soil.summ.sd%>% ggplot(aes(x=time, group= treatment, col= treatment, y= nitrogen_mean))+
  geom_line()+
  theme_classic()+
  xlab("Time")+
  ylab("Nitrogen")+
  scale_color_manual(values= treat.colors)+
  geom_point()+
  geom_errorbar(aes(ymin=nitrogen_mean-nitrogen_sd, ymax=nitrogen_mean+nitrogen_sd), width=0.2)
nitrogen.plotsd

```


```{r together, echo=FALSE}

figureall <- ggarrange(org.mat.plotsd, phosp.plotsd, pH_water.plotsd, potassium.plotsd, sodium.plotsd,calcium.plotsd, nitrogen.plotsd, conductivity.plotsd,
                    labels = c("A", "B", "C", "D", "E", "F", "G", "H"),
                    font.label = list (size = 10, color= "black"),
                    common.legend = TRUE, legend = "bottom",
                    vjust = 10,
                    ncol = 3, nrow = 3)
title <- text_grob("Soil properties over the time", 
                                color ="black", face = "bold", size = 14)


figure_title <- annotate_figure(figureall, 
                top=title, 
                bottom = text_grob("Mean and sd of each treatments"))

grid.draw(figure_title)

```

### Analisis estadistico.

### Check the correlation between the variables to analyse the most interesting ones.

```{r Correlogram, echo=FALSE}
soil_prop_cor <- soil_prop
soil_prop_cor$rep <- NULL
soil_prop_cor$soil.id <- NULL
soil_prop_cor$treatment <- NULL
soil_prop_cor$time <- NULL
cor.matrix <- soil_prop_cor %>% cor()

cor.mat.test <- cor.mtest(cor.matrix)

corrplot(cor.matrix, p.mat=cor.mat.test$p, sig.level = 0.05, order= "hclust", type= "upper", method= "number", insig = "pch", pch=4,number.cex = 0.75)
```

The most interesing variables seem to be pH.water, organic matter, conductivity and NPKCa values. The rest could be omitted. 

## Differences between treatments at the start of the experiment (t0)

Para comprobar si hay diferencias significativas o no. 
1.Dif. entre tratamientos y tiempos. 
2.Dif. entre 1 tratamiento a lo largo del tiempo. 

```{r Materia organica stats, echo=FALSE}

#Vamos analizar diferencias en el primer muestreo (to), por ello usamos la funcion subset que es un condicional como simbolo de dolar o funcion subset, para elegir determinadas variables dentro de un objeto,  significa solo analizar del archivo soil_prop, la columan soil_prop$time que sea igual a t0). Le hacemos un modelo de regresion lineal, o se puede analizar directamnte con anova. 
#comprobamos la normalidad de los datos por tratamiento y no entre tratamientos. Los datos al interaccionar entre tratamietnos no son normales, ya que por los procesos biologicos son mas altos en algunos tratamientos que otros. Asumiendo esto, los analisis estadisticos se haran igualmente con aproximacion parametrica. 

soilt0 <- subset(soil_prop, soil_prop$time== "t0")
str(soilt0)

shapiro.test(soilt0$org.matter)#ahora vamos a comprobar la normalidad de los datos. Los datos no son normales. 
soil_prop %>% group_by(treatment) %>% shapiro_test(org.matter) #aqui comprobamos la normalidad de los datos de materia organica en cada tratamiento. Todos son normales.

ggqqplot(data = soil_prop, "org.matter", facet.by = "treatment")

anova_orgmattert0 <- aov(org.matter ~ treatment, data=soilt0) #hay diferencias significativas
summary(anova_orgmattert0)
plot(anova_orgmattert0, which=2)
leveneTest(org.matter~ treatment, data=soilt0) #test de Levene para el analisis de la varianza

#Puesto que hay direferencias sig. vamos a comprobar entre que tratamientos. POST-HOC.

#### hsd tukey from agricolae::
tukey_orgmatter <- HSD.test(anova_orgmattert0, "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")
tukey_orgmatter

#crear un grafico con la media de la los valores de materia organica de t0, y la letra de HSDTukey)

avgm <- aggregate(org.matter ~ treatment, data=soilt0, FUN= mean)
plot_orgmatter_t0 <- soilt0 %>% ggplot(aes(x= treatment, y= org.matter))+
  geom_point()+
  stat_summary(fun=mean, aes(x= treatment, y = org.matter),
               geom= "crossbar", colour= "orange", data=avgm)+
  geom_text(data=tukey_orgmatter, aes(x=treatment, y = org.matter, label= groups), nudge_x= 0.2, nudge_y= 0.2)+
  labs(title = "Figure 1: Differences in organic matter at T0.", subtitle = "HSDTukey" , caption = "p-value" )
plot_orgmatter_t0

```

```{r Phosphorous stats, echo=FALSE}
shapiro.test(soilt0$phosphorus)#data no normal 
soilt0 %>% group_by(treatment) %>% shapiro_test(phosphorus) #all treatment are normal
ggqqplot(data = soil_prop, "phosphorus", facet.by = "treatment")
anova_phosphto <- aov(phosphorus ~ treatment, data=soilt0)
summary(anova_phosphto)
plot(anova_phosphto, which=2)
leveneTest(phosphorus~ treatment, data= soilt0)#se cumple el supuesto de homogenicidad de varianzas.
tukey_phosphorus <- HSD.test(anova_phosphto, "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")
avgpho <- aggregate(phosphorus ~ treatment, data=soilt0, FUN= mean)
plot_phosphorus_t0 <- soilt0 %>% ggplot(aes(x= treatment, y= phosphorus))+
  geom_point()+
  stat_summary(fun=mean, aes(x= treatment, y = phosphorus),
               geom= "crossbar", colour= "orange", data=avgpho)+
  geom_text(data=tukey_phosphorus, aes(x=treatment, y = phosphorus, label= groups), nudge_x= 0.2, nudge_y= 0.3)+
  labs(title = "Figure 2: Differences in phosphorus at T0.", subtitle = "HSDTukey" , caption = "p-value" )
plot_phosphorus_t0
```

```{r ph water stast, echo=FALSE}
shapiro.test(soilt0$ph.water)
soilt0 %>% group_by(treatment) %>% shapiro_test(ph.water) #normal data
ggqqplot(data = soil_prop, "ph.water", facet.by = "treatment")

anova_phwatert0 <- aov(ph.water ~ treatment, data=soilt0)
summary(anova_phwatert0)
plot(anova_phwatert0, which=2)
leveneTest(ph.water~ treatment, data= soilt0)#se cumple el supuesto de homogenicidad de varianzas.

tukey_phwater <- HSD.test(anova_phwatert0, "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")
avgphwater <- aggregate(ph.water ~ treatment, data=soilt0, FUN= mean)
plot_phwater_t0 <- soilt0 %>% ggplot(aes(x= treatment, y= ph.water))+
  geom_point()+
  stat_summary(fun=mean, aes(x= treatment, y = ph.water),
               geom= "crossbar", colour= "orange", data=avgphwater)+
  geom_text(data=tukey_phwater, aes(x=treatment, y = ph.water, label= groups), nudge_x= 0.2, nudge_y= 0.1)+
  labs(title = "Figure 3: Differences in ph water at T0.", subtitle = "HSDTukey" , caption = "p-value" )
plot_phwater_t0
```

```{r conductivity stats, echo=FALSE}
shapiro.test(soilt0$conductivity) #data no normal 
soil_prop %>% group_by(treatment) %>% shapiro_test(conductivity) #all treatment are normal
ggqqplot(data = soil_prop, "conductivity", facet.by = "treatment")
anova_conductivityt0 <- aov(conductivity ~ treatment, data=soilt0)
summary(anova_conductivityt0)
plot(anova_conductivityt0, which=2)
leveneTest(conductivity~ treatment, data= soilt0)
tukey_conductivity <- HSD.test(anova_conductivityt0, "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")
avgconduc <- aggregate(conductivity ~ treatment, data=soilt0, FUN= mean)
plot_conduc_t0 <- soilt0 %>% ggplot(aes(x= treatment, y= conductivity))+
  geom_point()+
  stat_summary(fun=mean, aes(x= treatment, y = conductivity),
               geom= "crossbar", colour= "orange", data=avgconduc)+
  geom_text(data=tukey_conductivity, aes(x=treatment, y = conductivity, label= groups), nudge_x= 0.2, nudge_y= 0.1)+
  labs(title = "Figure 4: Differences in conductivity at T0.", subtitle = "HSDTukey" , caption = "p-value, ojo un dato se va" )
plot_conduc_t0
```


```{r stats calcium, echo=FALSE}
shapiro.test(soilt0$calcium)#normal data
anova_calciumt0 <- aov(calcium ~ treatment, data=soilt0)
summary(anova_calciumt0)
plot(anova_calciumt0, which=2)
leveneTest(calcium~ treatment, data= soilt0)

tukey_calcium <- HSD.test(anova_calciumt0, "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")
avgcalcium <- aggregate(calcium ~ treatment, data=soilt0, FUN= mean)
plot_calcium_t0 <- soilt0 %>% ggplot(aes(x= treatment, y= calcium))+
  geom_point()+
  stat_summary(fun=mean, aes(x= treatment, y = calcium),
               geom= "crossbar", colour= "orange", data=avgcalcium)+
  geom_text(data=tukey_calcium, aes(x=treatment, y = calcium, label= groups), nudge_x= 0.2, nudge_y= 0.1)+
  labs(title = "Figure 5: Differences in calcium at T0.", subtitle = "HSDTukey" , caption = "p-value" )
plot_calcium_t0

```

```{r stats sodium, echo=FALSE}
shapiro.test(soilt0$sodium)#normal data
anova_sodiumt0 <- aov(sodium ~ treatment, data=soilt0)
summary(anova_sodiumt0)
plot(anova_sodiumt0, which=2)
leveneTest(sodium~ treatment, data= soilt0)

tukey_sodium <- HSD.test(anova_sodiumt0, "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")
avgsodium <- aggregate(sodium ~ treatment, data=soilt0, FUN= mean)
plot_sodium_t0 <- soilt0 %>% ggplot(aes(x= treatment, y= sodium))+
  geom_point()+
  stat_summary(fun=mean, aes(x= treatment, y = sodium),
               geom= "crossbar", colour= "orange", data=avgsodium)+
  geom_text(data=tukey_sodium, aes(x=treatment, y = sodium, label= groups), nudge_x= 0.2, nudge_y= 0.1)+
  labs(title = "Figure 6: No Differences in sodium at T0.", subtitle = "HSDTukey" , caption = "p-value" )
plot_sodium_t0
```

```{r stats potassium, echo=FALSE}
shapiro.test(soilt0$potassium) #normal data
anova_potassiumt0 <- aov(potassium ~ treatment, data=soilt0)
summary(anova_potassiumt0)
plot(anova_potassiumt0, which=2)
leveneTest(potassium~ treatment, data= soilt0)

tukey_potassium <- HSD.test(anova_potassiumt0, "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")
avgpotassium <- aggregate(potassium ~ treatment, data=soilt0, FUN= mean)
plot_potassium_t0 <- soilt0 %>% ggplot(aes(x= treatment, y= potassium))+
  geom_point()+
  stat_summary(fun=mean, aes(x= treatment, y = potassium),
               geom= "crossbar", colour= "orange", data=avgpotassium)+
  geom_text(data=tukey_potassium, aes(x=treatment, y = potassium, label= groups), nudge_x= 0.2, nudge_y= 0.1)+
  labs(title = "Figure 7: Differences in potassium at T0.", subtitle = "HSDTukey" , caption = "p-value" )
plot_potassium_t0
```


```{r stats nitrogent0, echo=FALSE}
shapiro.test(soilt0$nitrogen)#data no normal 
soil_prop %>% group_by(treatment) %>% shapiro_test(nitrogen) #all the treatments are normal
ggqqplot(data = soil_prop, "nitrogen", facet.by = "treatment")
anova_nitrogen0 <- aov(nitrogen ~ treatment, data=soilt0)
summary(anova_nitrogen0)
plot(anova_nitrogen0, which=2)
leveneTest(nitrogen~ treatment, data= soilt0)

tukey_nitrogen <- HSD.test(anova_nitrogen0, "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")
avgnitrogen <- aggregate(nitrogen ~ treatment, data=soilt0, FUN= mean)
plot_nitrogen_t0 <- soilt0 %>% ggplot(aes(x= treatment, y= nitrogen))+
  geom_point()+
  stat_summary(fun=mean, aes(x= treatment, y = nitrogen),
               geom= "crossbar", colour= "orange", data=avgnitrogen)+
  geom_text(data=tukey_nitrogen, aes(x=treatment, y = nitrogen, label= groups), nudge_x= 0.2, nudge_y= 0.0)+
  labs(title = "Figure 8: Differences in nitrogen at T0.", subtitle = "HSDTukey" , caption = "p-value" )
plot_nitrogen_t0

```

### Differences between treatments at the end of the experiment (t4)


```{r stats org.matter at the end, inclue=TRUE}
soilt4 <- subset(soil_prop, soil_prop$time== "t4")

shapiro.test(soilt4$org.matter) #normal data
anova_orgmattert4 <- aov(org.matter ~ treatment, data=soilt4) #sig. different
summary(anova_orgmattert4)
plot(anova_orgmattert4, which=2)
leveneTest(org.matter~ treatment, data=soilt4) #equal variances 

#### hsd tukey from agricolae::
tukey_orgmattert4 <- HSD.test(anova_orgmattert4, "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")
avgmt4 <- aggregate(org.matter ~ treatment, data=soilt4, FUN= mean)
plot_orgmatter_t4 <- soilt4 %>% ggplot(aes(x= treatment, y= org.matter))+
  geom_point()+
  stat_summary(fun=mean, aes(x= treatment, y = org.matter),
               geom= "crossbar", colour= "green4", data=avgmt4)+
  geom_text(data=tukey_orgmattert4, aes(x=treatment, y = org.matter, label= groups), nudge_x= 0.2, nudge_y= 0.2)+
  labs(title = "Figure 1: Differences in organic matter at T4.", subtitle = "HSDTukey" , caption = "p-value" )
plot_orgmatter_t4
```


```{r pho stas t4, echo=FALSE}
shapiro.test(soilt4$phosphorus) #no normal data
soilt4 %>% group_by(treatment) %>% shapiro_test(phosphorus) # all treatments normal
ggqqplot(data = soil_prop, "phosphorus", facet.by = "treatment")

anova_phosht4 <- aov(phosphorus ~ treatment, data=soilt4) #sig. different
summary(anova_phosht4)
plot(anova_phosht4, which=2)
leveneTest(phosphorus~ treatment, data=soilt4) #equal variances 

tukey_phosphorust4 <- HSD.test(anova_phosht4, "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")
avgpho4 <- aggregate(phosphorus ~ treatment, data=soilt4, FUN= mean)
plot_phosphorus_t4 <- soilt4 %>% ggplot(aes(x= treatment, y= phosphorus))+
  geom_point()+
  stat_summary(fun=mean, aes(x= treatment, y = phosphorus),
               geom= "crossbar", colour= "green4", data=avgpho4)+
  geom_text(data=tukey_phosphorust4, aes(x=treatment, y = phosphorus, label= groups), nudge_x= 0.2, nudge_y= 0.01)+
  labs(title = "Figure 2: Differences in phosphorus at T4.", subtitle = "HSDTukey" , caption = "p-value" )
plot_phosphorus_t4
```
```{r stats ph water t4, echo=FALSE}
shapiro.test(soilt4$ph.water) #no normal data
soil_prop %>% group_by(treatment) %>% shapiro_test(ph.water) # each treatments are normal 
ggqqplot(data = soil_prop, "ph.water", facet.by = "treatment")

anova_phwatert4 <- aov(ph.water ~ treatment, data=soilt4) #sig. different
summary(anova_phwatert4)
plot(anova_phwatert4, which=2)
leveneTest(ph.water~ treatment, data=soilt4) # no equal variances 

tukey_phwatert4 <- HSD.test(anova_phwatert4, "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")
tukey_phwatert4

avgphwatert4 <- aggregate(ph.water ~ treatment, data=soilt4, FUN= mean)
plot_phwater_t4 <- soilt4 %>% ggplot(aes(x= treatment, y= ph.water))+
  geom_point()+
  stat_summary(fun=mean, aes(x= treatment, y = ph.water),
               geom= "crossbar", colour= "green4", data=avgphwatert4)+
  geom_text(data=tukey_phwatert4, aes(x=treatment, y = ph.water, label= groups), nudge_x= 0.2, nudge_y= 0.01)+
  labs(title = "Figure 3: Differences in ph.water at T4.", subtitle = "HSDTukey" , caption = "p-value" )
plot_phwater_t4

```

```{r stats conductivity t4, include=FALSE}
shapiro.test(soilt4$conductivity) #no normal data
soil_prop %>% group_by(treatment) %>% shapiro_test(conductivity) # each treatments are normal 
ggqqplot(data = soil_prop, "conductivity", facet.by = "treatment")

anova_conductivityt4 <- aov(conductivity ~ treatment, data=soilt4) #sig. different
summary(anova_conductivityt4)
plot(anova_conductivityt4, which=2)
leveneTest(conductivity~ treatment, data=soilt4) #equal variances 
tukey_conductivityt4 <- HSD.test(anova_conductivityt4, "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")
avgconduct4 <- aggregate(conductivity ~ treatment, data=soilt4, FUN= mean)
plot_conduc_t4 <- soilt4 %>% ggplot(aes(x= treatment, y= conductivity))+
  geom_point()+
  stat_summary(fun=mean, aes(x= treatment, y = conductivity),
               geom= "crossbar", colour= "green4", data=avgconduct4)+
  geom_text(data=tukey_conductivityt4, aes(x=treatment, y = conductivity, label= groups), nudge_x= 0.2, nudge_y= 0.01)+
  labs(title = "Figure 4: Differences in conductivity at T4.", subtitle = "HSDTukey" , caption = "p-value" )
plot_conduc_t4
```


```{r stats calcium t4, echo=FALSE}
shapiro.test(soilt4$calcium) #normal data
anova_calciumt4 <- aov(calcium ~ treatment, data=soilt4) #sig. different
summary(anova_calciumt4)
plot(anova_phwatert4, which=2)
leveneTest(calcium~ treatment, data=soilt4) # equal variances 

#### hsd tukey from agricolae::
tukey_calciumt4 <- HSD.test(anova_calciumt4, "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")
avgcalciumt4 <- aggregate(calcium ~ treatment, data=soilt4, FUN= mean)
plot_calcium_t4 <- soilt4 %>% ggplot(aes(x= treatment, y= calcium))+
  geom_point()+
  stat_summary(fun=mean, aes(x= treatment, y = calcium),
               geom= "crossbar", colour= "green4", data=avgcalciumt4)+
  geom_text(data=tukey_calciumt4, aes(x=treatment, y = calcium, label= groups), nudge_x= 0.2, nudge_y= 0.2)+
  labs(title = "Figure 5: Differences in calcium at T4.", subtitle = "HSDTukey" , caption = "p-value" )
plot_calcium_t4
```
```{r stats sodium t4, echo=FALSE}
shapiro.test(soilt4$sodium) #normal data
anova_sodiumt4 <- aov(sodium ~ treatment, data=soilt4) #sig. different
summary(anova_sodiumt4)
plot(anova_sodiumt4, which=2)
leveneTest(sodium~ treatment, data=soilt4) # equal variances 

#### hsd tukey from agricolae::
tukey_sodiumt4 <- HSD.test(anova_sodiumt4, "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")
avgsodiumt4 <- aggregate(sodium~ treatment, data=soilt4, FUN= mean)
plot_sodium_t4 <- soilt4 %>% ggplot(aes(x= treatment, y= sodium))+
  geom_point()+
  stat_summary(fun=mean, aes(x= treatment, y = sodium),
               geom= "crossbar", colour= "green4", data=avgsodiumt4)+
  geom_text(data=tukey_sodiumt4, aes(x=treatment, y = sodium, label= groups), nudge_x= 0.2, nudge_y= 0.2)+
  labs(title = "Figure 6: Differences in sodium at T4.", subtitle = "HSDTukey" , caption = "p-value" )
plot_sodium_t4
```
```{r stats potassium t4, echo=FALSE}
shapiro.test(soilt4$potassium) #normal data
soilt4 %>% group_by(treatment) %>% shapiro_test(potassium) # each treatments are normal 
anova_potassiumt4 <- aov(potassium ~ treatment, data=soilt4) #sig. different
summary(anova_potassiumt4)
plot(anova_potassiumt4, which=2)
leveneTest(potassium~ treatment, data=soilt4) # equal variances 

#### hsd tukey from agricolae::
tukey_potassiumt4 <- HSD.test(anova_potassiumt4, "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")
avgpotassiumt4 <- aggregate(potassium~ treatment, data=soilt4, FUN= mean)
plot_potassium_t4 <- soilt4 %>% ggplot(aes(x= treatment, y= potassium))+
  geom_point()+
  stat_summary(fun=mean, aes(x= treatment, y = potassium),
               geom= "crossbar", colour= "green4", data=avgpotassiumt4)+
  geom_text(data=tukey_potassiumt4, aes(x=treatment, y = potassium, label= groups), nudge_x= 0.2, nudge_y= 0.2)+
  labs(title = "Figure 7: Differences in potassium at T4.", subtitle = "HSDTukey" , caption = "p-value" )
plot_potassium_t4
```

```{r stats nitrogent4, echo=FALSE}
shapiro.test(soilt4$nitrogen) #normal data
anova_nitrogent4 <- aov(nitrogen ~ treatment, data=soilt4) #sig. different
summary(anova_nitrogent4)
plot(anova_nitrogent4, which=2)
leveneTest(nitrogen~ treatment, data=soilt4) # equal variances 

#### hsd tukey from agricolae::
tukey_nitrogent4 <- HSD.test(anova_nitrogent4, "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")
avgnitrogent4 <- aggregate(nitrogen~ treatment, data=soilt4, FUN= mean)
plot_nitrogen_t4 <- soilt4 %>% ggplot(aes(x= treatment, y= nitrogen))+
  geom_point()+
  stat_summary(fun=mean, aes(x= treatment, y = nitrogen),
               geom= "crossbar", colour= "green4", data=avgnitrogent4)+
  geom_text(data=tukey_nitrogent4, aes(x=treatment, y = nitrogen, label= groups), nudge_x= 0.2, nudge_y= 0.01)+
  labs(title = "Figure 8: Differences in nitrogen at T4.", subtitle = "HSDTukey" , caption = "p-value" )
plot_nitrogen_t4
```

### Differences between the beginning at the end of the experiment (T0 vs T4)


```{r stats orgmatter t0t4, include=TRUE}
soilt0t4 <- soil_prop %>% filter(time == "t0" | time == "t4") #data only t0 and t4
soilt0t4
shapiro.test(soilt0t4$org.matter) #no normal data
soilt0t4 %>% group_by(treatment) %>% shapiro_test(org.matter) # each treatments are normal 
ggqqplot(data = soilt0t4, "org.matter", facet.by = "treatment")
anova_orgt0t4 <- aov(org.matter ~ time + treatment, data=soilt0t4) #anova two ways
summary(anova_orgt0t4)
anova_orgt0t4int <- aov(org.matter ~ time * treatment , data=soilt0t4) #add rep= "block" To control for the effect of the differences between the 3 replicates # interaction between them?
summary(anova_orgt0t4int)
leveneTest(org.matter ~ time * treatment, data=soilt0t4) #equal variances 


orglm <- lm(org.matter~ time*treatment, data=soilt0t4)#model
anova(orglm)
summary(anova(orglm))

emm_org <- emmeans(orglm, pairwise ~ time | treatment)
emm_org

#el adjust es para el metodo de los pvalues
emm_org$contrasts %>% rbind(adjust= "fdr") %>% summary(infer = TRUE)

emm_org <- cld(emmeans(orglm, specs = pairwise~treatment), Letters= letters, reversed= TRUE)
#tabla con las diferencias sig y las letras se lo indicas 
emm_org
#tabla con los resultados. Se hacen dataframe para sacar las columnas que queremos y poder unirlas en los graficos 

orgcontras <- data.frame(emm_org$contrasts)#data frame para sacar el valor del contraste 
orgcontras
orgemmeans <- data.frame(emm_org$emmeans) %>% group_by(treatment) %>% summarise(across(.cols= "emmean",.fns=mean),.groups = "drop")
str(orgcontras)

pval.org.mat.time <- data.frame(treatment= orgcontras$treatment, pval= orgcontras$p.value, emmean= orgemmeans$emmean)

pval.org.mat.time$sign <- ifelse(pval.org.mat.time$pval>0.05, paste("ns"),
                                 ifelse(pval.org.mat.time$pval>0.01, paste("*"),
                                        ifelse(pval.org.mat.time$pval> 0.001,
                                               paste("**"), paste("***"))))#para add la significancia con el condicional ifelse

#para hacer el delta, es decir cuanto ha variado la materia organica.. Hay que tener los archivos x separado  
mat.org.t0 <- subset(soilt0t4, soilt0t4$time == "t0")
mat.org.t0 <- data.frame( treatment=mat.org.t0$treatment, org.matter.t0= mat.org.t0$org.matter)
mat.org.t4 <- subset(soilt0t4, soilt0t4$time == "t4")
mat.org.t4 <- data.frame( treatment=mat.org.t4$treatment, org.matter.t4= mat.org.t4$org.matter)

delta.mat.org <- data.frame(treatment= mat.org.t0$treatment,t4= mat.org.t4$org.matter.t4 ,t0= mat.org.t0$org.matter.t0)
delta.mat.org$delta <- delta.mat.org$t4-delta.mat.org$t0
#delta.mat.org$ratio <- delta.mat.org$t4/delta.mat.org$t0
delta.mat.org
delta.org.lm <- lm(delta~ treatment, data=delta.mat.org)#model
anova(delta.org.lm)

emm.delta.org <- emmeans(delta.org.lm, pairwise ~  treatment, adjust= "tukey")#how to add tukey
emm.delta.org$contrasts %>% rbind(adjust= "fdr") %>% 
  summary(infer = TRUE)
emm.delta.org <- cld(emmeans(delta.org.lm, specs = pairwise~treatment), Letters= letters, reversed= TRUE)
emm.delta.org$.group#letras 

plotdeltaorg <-delta.mat.org %>% ggplot(aes(x= treatment, y= delta, fill= treatment))+
  geom_point(pch= 21, size= 5)+
  scale_fill_manual(values= treat.colors)+
  ylab("Delta (t4-t0)")+
  geom_text(data= emm.delta.org, aes(x= treatment, y= emmean, label= `.group`), nudge_x = 0.2, nudge_y = 0.2)
plotdeltaorg
soilt0t4mean <- soilt0t4 %>% group_by(treatment,  time) %>% 
  summarise(across(.cols=everything(),.fns=mean),.groups = "drop")

soilt0t4mean
plot1 <- soilt0t4mean %>% ggplot(aes(x= treatment, y= org.matter))+
  geom_col(aes(fill= time),position= "dodge")+
  geom_text(data = pval.org.mat.time, aes(x= treatment, y= emmean, label= sign))
plot1

#unir los dos graficos
orgt0t4 <- ggarrange(plot1, plotdeltaorg)

orgt0t4
#plot_orgmatter_t0t4 #preguntar ignacio

```



```{r stas phosphorus t0t4, echo=FALSE}
shapiro.test(soilt0t4$phosphorus) #no normal data
soilt0t4 %>% group_by(treatment) %>% shapiro_test(phosphorus) # no normal data. the group of each data are normal in t0 and t4.
anova_phosphot0t4int <- aov(phosphorus ~ time * treatment, data=soilt0t4)# interaction between them
summary(anova_phosphot0t4int)
leveneTest(phosphorus ~ time * treatment, data=soilt0t4) #equal variances 

#delta variation 
phosp.t0 <- subset(soilt0t4, soilt0t4$time == "t0")

phosp.t0 <- data.frame(treatment=phosp.t0$treatment, 
                       phospho.t0= phosp.t0$phosphorus)

phosp.t4 <- subset(soilt0t4, soilt0t4$time == "t4")

phosp.t4 <- data.frame(treatment=phosp.t4$treatment, 
                       phospho.t4= phosp.t4$phosphorus)

delta.phosp <- data.frame(treatment=phosp.t0$treatment,
                            t4=phosp.t4$phospho.t4,
                            t0=phosp.t0$phospho.t0)
delta.phosp$delta <- delta.mat.org$t4-delta.mat.org$t0

delta.phosp

delta.phosp.lm <- lm(delta~ treatment, data=delta.phosp)#model
anova(delta.phosp.lm )

emm.delta.phosp <- emmeans(delta.phosp.lm, pairwise ~  treatment, adjust= "tukey")#how to add tukey
emm.delta.phosp$contrasts %>% rbind(adjust= "fdr") %>% 
  summary(infer = TRUE)
emm.delta.phosp <- cld(emmeans(delta.phosp.lm, specs = pairwise~treatment), Letters= letters, reversed= TRUE)
emm.delta.phosp
emm.delta.phosp$.group#letras 

plotdeltapho <-delta.phosp %>% ggplot(aes(x= treatment, y= delta, 
  fill= treatment))+
  geom_point(pch= 21, size= 8)+
  scale_fill_manual(values= treat.colors)+
  ylab("Delta phosphorus (t4-t0)")+
  xlab(",")+
  theme_bw()+
  geom_text(data= emm.delta.phosp, aes(x= treatment, y= emmean, label= `.group`), nudge_x = 0.2, nudge_y = 0.2)
plotdeltapho

#emmeans cambios entre tratamientos durante el tiempo

phosp_lm <- lm(phosphorus~ time*treatment, data=soilt0t4)#model interact
anova(phosp_lm)

emm_phosp <- emmeans(phosp_lm, pairwise ~ time | treatment)
emm_phosp
emm_phosp$contrasts %>% rbind(adjust= "fdr") %>% summary(infer = TRUE)

emm_phosp <- cld(emmeans(phosp_lm, specs = pairwise~treatment), Letters= letters, reversed= TRUE)
emm_phosp
phospcontras <- data.frame(emm_phosp$contrasts)
phospcontras
phospemmeans <- data.frame(emm_phosp$emmeans) %>% group_by(treatment) %>% summarise(across(.cols= "emmean",.fns=mean),.groups = "drop")

pval.phosp.time <- data.frame(treatment= phospcontras$treatment, pval= phospcontras$p.value, emmean= phospemmeans$emmean)

pval.phosp.time$sign <- ifelse(pval.phosp.time$pval>0.05, paste("ns"),
                                 ifelse(pval.phosp.time$pval>0.01, paste("*"),
                                        ifelse(pval.phosp.time$pval> 0.001,
                                               paste("**"), paste("***"))))

plot1_phosp <- soilt0t4mean %>% ggplot(aes(x= treatment, y= phosphorus))+
  geom_col(aes(fill= time),position= "dodge")+
  geom_text(data = pval.phosp.time, aes(x= treatment, y= emmean, label= sign), nudge_x = 0, nudge_y = 28)
plot1_phosp

```




```{r stats ph water t0t4, echo=FALSE}
shapiro.test(soilt0t4$ph.water) #no normal data
soilt0t4 %>% group_by(treatment) %>% shapiro_test(ph.water) # each treatment are normal.
anova_phwatert0t4 <- aov(ph.water~ time + treatment, data=soilt0t4) #anova two ways
summary(anova_phwatert0t4)
anova_phwatert0t4int <- aov(ph.water ~ time * treatment + rep, data=soilt0t4) #add rep= "block" To control for the effect of the differences between the 3 replicates # interaction between them?
summary(anova_phwatert0t4int)
leveneTest(ph.water ~ time * treatment, data=soilt0t4) #equal variances p 0.48

tukey_phwatert0t4time <- HSD.test(anova_phwatert0t4int, "time", alpha = 0.05)$groups %>% rownames_to_column(var = "time")
tukey_phwatert0t4time
tukey_phwatert0t4treat <- HSD.test(anova_phwatert0t4int, "treatment", alpha = 0.05)$groups %>% rownames_to_column(var = "treatment")
tukey_phwatert0t4treat
phwater_plot_interac <- soilt0t4%>% ggplot(aes(x=treatment, group= time, col= time, y= ph.water))+ geom_point()+
  labs(title = "pH water", subtitle = "HSDTukey" , caption = "p-value" )
phwater_plot_interac

```

```{r stats conductivity t0t4, echo=FALSE}
shapiro.test(soilt0t4$conductivity) #no normal data
soilt0t4 %>% group_by(treatment) %>% shapiro_test(conductivity) # each treatment are normal.
anova_conduct0t4 <- aov(conductivity~ time + treatment, data=soilt0t4) #anova two ways
summary(anova_conduct0t4)
anova_conduct0t4int <- aov(conductivity ~ time * treatment + rep, data=soilt0t4) #add rep= "block" To control for the effect of the differences between the 3 replicates # interaction between them?
summary(anova_conduct0t4int)
leveneTest(conductivity ~ time * treatment, data=soilt0t4) #equal variances p 0.48

tukey_conduct0t4time <- HSD.test(anova_conduct0t4int, "time", alpha = 0.05)$groups %>% rownames_to_column(var = "time")
tukey_conduct0t4time
tukey_conduct0t4treat <- HSD.test(anova_conduct0t4int, "treatment", alpha = 0.05)$groups %>% rownames_to_column(var = "treatment")
tukey_conduct0t4treat
conduct_plot_interac <- soilt0t4%>% ggplot(aes(x=treatment, group= time, col= time, y= conductivity))+ geom_point()+
  labs(title = "Conductivity", subtitle = "HSDTukey" , caption = "p-value" )
conduct_plot_interac
```

```{r stas calcium t0t4, echo=FALSE}
shapiro.test(soilt0t4$calcium) # normal data
anova_calciumt0t4 <- aov(calcium~ time + treatment, data=soilt0t4) #anova two ways
summary(anova_calciumt0t4)
anova_calciumt0t4int <- aov(calcium ~ time * treatment + rep, data=soilt0t4) #add rep= "block" To control for the effect of the differences between the 3 replicates # interaction between them?
summary(anova_calciumt0t4int)
leveneTest(calcium ~ time * treatment, data=soilt0t4) #equal variances

tukey_calciumt0t4time <- HSD.test(anova_calciumt0t4int, "time", alpha = 0.05)$groups %>% rownames_to_column(var = "time")
tukey_calciumt0t4time
tukey_calciumt0t4treat <- HSD.test(anova_calciumt0t4int, "treatment", alpha = 0.05)$groups %>% rownames_to_column(var = "treatment")
tukey_calciumt0t4treat
calcium_plot_interac <- soilt0t4%>% ggplot(aes(x=treatment, group= time, col= time, y= calcium))+ geom_point()+
  labs(title = "Calcium", subtitle = "HSDTukey" , caption = "p-value" )
calcium_plot_interac

```

```{r stats sodium t0t4, echo=FALSE}
shapiro.test(soilt0t4$sodium) # no normal data
soilt0t4 %>% group_by(treatment) %>% shapiro_test(sodium) # each treatment are normal in the different times. 
anova_sodiumt0t4 <- aov(sodium~ time + treatment, data=soilt0t4) #anova two ways
summary(anova_sodiumt0t4)
anova_sodiumt0t4int <- aov(sodium ~ time * treatment + rep, data=soilt0t4) #add rep= "block" To control for the effect of the differences between the 3 replicates # interaction between them?
summary(anova_sodiumt0t4int)
leveneTest(sodium ~ time * treatment, data=soilt0t4) #equal variances p 0.48

tukey_sodiumt0t4time <- HSD.test(anova_sodiumt0t4int, "time", alpha = 0.05)$groups %>% rownames_to_column(var = "time")
tukey_sodiumt0t4time
tukey_sodiumt0t4treat <- HSD.test(anova_sodiumt0t4int, "treatment", alpha = 0.05)$groups %>% rownames_to_column(var = "treatment")
tukey_sodiumt0t4treat
sodium_plot_interac <- soilt0t4%>% ggplot(aes(x=treatment, group= time, col= time, y= sodium))+ geom_point()+
  labs(title = "Sodium", subtitle = "HSDTukey" , caption = "p-value" )
sodium_plot_interac

```

```{r stats potassium t0t4, echo=FALSE}
shapiro.test(soilt0t4$potassium) #normal data
anova_potassiumt0t4 <- aov(potassium~ time + treatment, data=soilt0t4) #anova two ways
summary(anova_potassiumt0t4)
anova_potassiumt0t4int <- aov(potassium ~ time * treatment + rep, data=soilt0t4) #add rep= "block" To control for the effect of the differences between the 3 replicates # interaction between them?
summary(anova_potassiumt0t4int)
leveneTest(potassium ~ time * treatment, data=soilt0t4) #equal variances

tukey_potassiumt0t4time <- HSD.test(anova_potassiumt0t4int, "time", alpha = 0.05)$groups %>% rownames_to_column(var = "time")
tukey_potassiumt0t4time
tukey_potassiumt0t4treat <- HSD.test(anova_potassiumt0t4int, "treatment", alpha = 0.05)$groups %>% rownames_to_column(var = "treatment")
tukey_potassiumt0t4treat
potassium_plot_interac <- soilt0t4%>% ggplot(aes(x=treatment, group= time, col= time, y= potassium))+ geom_point()+
  labs(title = "Potassium", subtitle = "HSDTukey" , caption = "p-value" )
potassium_plot_interac

```


```{r stats nitrogen t0t4, echo=FALSE}
shapiro.test(soilt0t4$nitrogen) #normal data
anova_nitrogent0t4 <- aov(nitrogen~ time + treatment, data=soilt0t4) #anova two ways
summary(anova_nitrogent0t4)
anova_nitrogent0t4int <- aov(nitrogen ~ time * treatment + rep, data=soilt0t4) #add rep= "block" To control for the effect of the differences between the 3 replicates # interaction between them?
summary(anova_nitrogent0t4int)
leveneTest(nitrogen ~ time * treatment, data=soilt0t4) #equal variances

tukey_nitrogent0t4time <- HSD.test(anova_nitrogent0t4int, "time", alpha = 0.05)$groups %>% rownames_to_column(var = "time")
tukey_nitrogent0t4time
tukey_nitrogent0t4treat <- HSD.test(anova_nitrogent0t4int, "treatment", alpha = 0.05)$groups %>% rownames_to_column(var = "treatment")
tukey_nitrogent0t4treat
nitrogen_plot_interac <- soilt0t4%>% ggplot(aes(x=treatment, group= time, col= time, y= nitrogen))+ geom_point()+
  labs(title = "Nitrogen", subtitle = "HSDTukey" , caption = "p-value" )
nitrogen_plot_interac

```

