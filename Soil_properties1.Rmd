---
title: "Banana project, organic matter-microbiome"
output: html_document
date: "`r Sys.Date()`"
---

```{r, include=FALSE}
library(ggplot2)
library(tidyverse)
library(ggpubr)
library(gridExtra)
library(corrplot)
library(agricolae)
library(emmeans)
library(multcomp)
library(multcompView)
library(data.table)
library(tidyverse)
library(phyloseq)
library(vegan)
library(ape)
library(here)
library(readxl)
library(ggpubr)
library(geomtextpath)
library(knitr)
library(gridExtra)
library(Biostrings)
library(seqinr)
library(FSA)
library(agricolae)
library(MASS)
library(grid)
library(gridExtra)
library(emmeans)
library(multcomp)
library(broom)
library(viridis)
library(ALDEx2)
library(FactoMineR)
library(factoextra)
library(kableExtra)
library(scales)
library(dunn.test)
library(car)
library(corrplot)
library(eulerr)
library(ggforce)
library(ggrepel)
avgp1 <- rm
sqrt <- rm
avg <- rm
plot.org.t0 <- rm

plot.pho.t01<- rm
```


# Analisis de datos octubre 2023


```{r Palette, include= FALSE}

banana.paleta = list(
  paleta.treat = c("#FFC125", "#8B7D6B", "#81bc1f", "#ddec76",
                 "#a4e361", "#27408B", "#EE5C42"),
  my_favourite_colours = c("#702963", "#637029",    "#296370"))


banana.paleta.f = function(name, n, all_palettes = banana.paleta, type = c("discrete", "continuous")) {
  palette = all_palettes[[name]]
  if (missing(n)) {
    n = length(palette)
  }
  type = match.arg(type)
  out = switch(type,
               continuous = grDevices::colorRampPalette(palette)(n),
               discrete = palette[1:n] )
  structure(out, name = name, class = "palette")
}
banana.paleta.f("paleta.treat", all_palettes = banana.paleta, type= "discrete")

scale_colour_banana_disc = function(name) {
  ggplot2::scale_colour_manual(values = banana.paleta.f(name, type = "discrete"))
}

scale_fill_banana_disc = function(name) {
  ggplot2::scale_fill_manual(values = banana.paleta.f(name,
                                                     type = "discrete"))
}

```

## Propidedades del suelo

Esto se ha hecho para cargar el Excel de los datos iniciales (ojo, para poner el directorio de donde esta tu archivo excel, se tiene que cambiar \, por /), y para hacer la media de cada tratamiento, ya que de cada tratamiento hay 3 repeticiones. El simbolo %>% se llaman tuberias (the pipe) vienen de la libreria (tinyverse) (esta libreria sirve para mantener R m치s ordenado). Las tuberias funcionan usando el resultado de una operaci칩n(out) y convirtiendolo en el imput de otra. En el caso del codigo  "soil.summ <- soil_prop %>% group_by(treatment,  time) %>% summarise(across(.cols=everything(), .fns=mean),.groups = "drop")" quiere decir lo siguiente: hemos creado un objeto nuevo que es soil.summ, que es_ el archivo de excel soil_prop el que hacemos una serie de operaciones en cadena (tuberia) donde agrupamos solamente por tratamiento y tiempo (group_by,) y en ese agrupamiento queremos de todas las columnas, .cols=every, que haga la funcion de la media (fns=mean). NULL significa que no tenga en cuenta esas columnas. $ es para seleccionar cosas especificas. 
```{r Import, include=FALSE}
soil_prop <- readxl::read_excel("C:/Users/raquel.correa/Documents/banana_microbiome/raw_files/soil_prop_2.xlsx")

soil.summ <- soil_prop %>% group_by(treatment,  time) %>% 
  summarise(across(.cols=everything(),.fns=mean),.groups = "drop")

soil.summ.sd <- soil_prop %>% group_by(treatment,  time) %>% 
  summarise(across(.cols=everything(),.fns=list(mean = mean, sd = sd)),.groups = "drop")

soil.summ$rep <- NULL
soil.summ$soil.id <- NULL

```

### Evolucion de cada parametros en los distintos muestreos del experimento

En este codigo veremos la evolucion de los distintos parametros en el tiempo. 
La funci칩n "aes" sirve para indicar en un grafico cual es tu X,y. Debes indicar en texto quien es quien.Toda la informaci칩n de los datos referido al grafico es lo que va dentro del parentesis. Los adornos van fuera con el signo de +. La funcion "geom_line" sirve para elegir el tipo de grafico que quieres. 

```{r Materia organica plot, include= TRUE}
org.mat.plotsd <- soil.summ.sd%>% ggplot(aes(x=time, group= treatment, col= treatment, y= org.matter_mean))+
  geom_line()+
  scale_colour_banana_disc("paleta.treat")+
  geom_point()+
  geom_errorbar(aes(ymin=org.matter_mean-org.matter_sd, ymax=org.matter_mean+org.matter_sd), width=0.2)
org.mat.plotsd
 

```
![Figure 1: organic matter over time in diffrerent treatments.]

```{r Fosforo plot, echo=FALSE}
phosp.plotsd <- soil.summ.sd%>% ggplot(aes(x=time, group= treatment, col= treatment, y=phosphorus_mean))+
  geom_line()+
  scale_colour_banana_disc("paleta.treat")+
  geom_point()+
  geom_errorbar(aes(ymin=phosphorus_mean-phosphorus_sd, ymax=phosphorus_mean+phosphorus_sd), width=0.2)

phosp.plotsd

```
![Figure 2: phosphorous over time in different treatments.]

```{r Calcium plot, echo=FALSE}

calcium.plotsd <- soil.summ.sd%>% ggplot(aes(x=time, group= treatment, col= treatment, y= calcium_mean))+
  geom_line()+
  scale_colour_banana_disc("paleta.treat")+
  geom_point()+
  geom_errorbar(aes(ymin=calcium_mean-calcium_sd, ymax=calcium_mean+calcium_sd), width=0.2)

calcium.plotsd

```
![Figure 3. calcium over time in different treatments.]

```{r sodium plot, echo=FALSE}

sodium.plotsd <- soil.summ.sd%>% ggplot(aes(x=time, group= treatment, col= treatment, y= sodium_mean))+
  geom_line()+
  scale_colour_banana_disc("paleta.treat")+
  geom_point()+
  geom_errorbar(aes(ymin=sodium_mean-sodium_sd, ymax=sodium_mean+sodium_sd), width=0.2)

sodium.plotsd
```
![Figure 4: sodium over time in different treatments.]


```{r postassium plot, echo=FALSE}
potassium.plotsd <- soil.summ.sd%>% ggplot(aes(x=time, group= treatment, col= treatment, y= potassium_mean))+
  geom_line()+
  scale_colour_banana_disc("paleta.treat")+
  geom_point()+
  geom_errorbar(aes(ymin=potassium_mean-potassium_sd, ymax=potassium_mean+potassium_sd), width=0.2)

potassium.plotsd

```
![Figure 5: potassium over time in different treatments.]


```{r pH agua plot, echo=FALSE}

pH_water.plotsd <- soil.summ.sd%>% ggplot(aes(x=time, group= treatment, col= treatment, y= ph.water_mean))+
  geom_line()+
  scale_colour_banana_disc("paleta.treat")+
  geom_point()+
  geom_errorbar(aes(ymin=ph.water_mean-ph.water_sd, ymax=ph.water_mean+ph.water_sd), width=0.2)

pH_water.plotsd

```
![Figure 6: pH water over time in different treatments.]

```{r conductivity plot, echo=FALSE}
conductivity.plotsd <- soil.summ.sd%>% ggplot(aes(x=time, group= treatment, col= treatment, y= conductivity_mean))+
  geom_line()+
  scale_colour_banana_disc("paleta.treat")+
  geom_point()+
  geom_errorbar(aes(ymin=conductivity_mean-conductivity_sd, ymax=conductivity_mean+conductivity_sd), width=0.2)

conductivity.plotsd

```
![Figure 7: conductivity over time in different treatments.]

```{r nitrogen plot, echo=FALSE}
nitrogen.plotsd <- soil.summ.sd%>% ggplot(aes(x=time, group= treatment, col= treatment, y= nitrogen_mean))+
  geom_line()+
  scale_colour_banana_disc("paleta.treat")+
  geom_point()+
  geom_errorbar(aes(ymin=nitrogen_mean-nitrogen_sd, ymax=nitrogen_mean+nitrogen_sd), width=0.2)

nitrogen.plotsd

```
![Figure 8: nitrogen over time in different treatments.]


### Analisis estadistico.

## Materia organica 

Para comprobar si hay diferencias significativas o no. 
1.Dif. entre tratamientos y tiempos. 
2.Dif. entre 1 tratamiento a lo largo del tiempo. 
Vamos analizar diferencias en el primer muestreo (to), por ello usamos la funcion subset que es un condicional como simbolo de dolar o funcion subset, para elegir determinadas variables dentro de un objeto,  significa solo analizar del archivo soil_prop, la columan soil_prop$time que sea igual a t0)
Le hacemos un modelo de regresion lineal, o se puede analizar directamnte con anova. 


```{r Materia organica stats, include=TRUE}
soilt0 <- subset(soil_prop, soil_prop$time== "t0")

shapiro.test(soilt0$org.matter)#ahora vamos a comprobar la normalidad de los datos. Los datos no son normales. Hay que transformarlos. Lo haremos con log.

org.trans <- log(soilt0$org.matter)

org.mat.trans <- data.frame(org.trans)

soilt0$trans.org <- log(soilt0$org.matter)
soilt0$trans.org

shapiro.test(soilt0$trans.org)#ahora si son normales. 
hist(soilt0$trans.org) #comprobamos con grafico
plot(soilt0$trans.org)
anova.org.matter.t0 <- aov(soilt0$trans.org~ treatment, data=soilt0)
summary(anova.org.matter.t0)
plot(anova.org.matter.t0, which=2)

#test de Levene para el analisis de la varianza
leveneTest(soilt0$trans.org~ treatment, data=soilt0)
## el valor de p es mayor que 0.05, se cumple el supuesto de homogenicidad de varianzas.


```


```{r Materia organica stats POST-HOC, include=TRUE}

#Puesto que hay direferencias sig. vamos a comprobar entre que tratamientos. POST-HOC.

#### hsd tuckey from agricolae::
hsd.t0.org <- HSD.test(anova.org.matter.t0, "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")

hsd.t0.org #preguntar ignacio como ver los resultados en un grafico

```
[!Diferencias sig. entre tratamients para t0. Los datos estan transformados con logaritmo]


## Phosphorus

```{r Phosphorous stats, include=TRUE}
soilt0

shapiro.test(soilt0$phosphorus) #LOS DATOS NO SON NORMALES. preguntar ignacio mejor forma para normalizar datos
ks.test(soilt0$phosphorus, pnorm)
soilt0$trans.phospo <- log(soilt0$phosphorus)             
shapiro.test(soilt0$trans.phospo)            
par(mfrow=c(2,2), cex.axis=1.5, lwd=2, font.lab=1.5)

anova.pho.to.trans <- aov(soilt0$trans.phospo~ treatment, data=soilt0)
summary(anova.pho.to.trans)

plot(anova.pho.to.trans, which=2)

leveneTest(phosphorus~ treatment, data= soilt0)
# el valor de p es mayor que 0.05, se cumple el supuesto de homogenicidad de varianzas.
```


```{r Phosphorus POST-HOC, include=TRUE}

#Puesto que hay direferencias sig. vamos a comprobar entre que tratamientos. POST-HOC.

#### hsd tuckey from agricolae::
hsd.t0.pho <- HSD.test(anova.pho.to.trans, "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")

hsd.t0.pho

```
![Diferencias sig.entre tratamientos de phosphorus en t0. datos transformados.]

## ph water


```{r ph water stast, include=TRUE}
lm.t0.ph <- rm
shapiro.test(soilt0$ph.water)
hist(soilt0$ph.water)

soilt0$trans.phwater <- log(soilt0$ph.water)

hist(soilt0$trans.phwater)
shapiro.test(soilt0$trans.phwater)#no son normales dps de transformar

anova.phwater.to.trans <- aov(soilt0$trans.phwater ~ treatment, data = soilt0)
summary(anova.phwater.to.trans)

leveneTest(soilt0$trans.phwater ~ treatment, data= soilt0) 

```

```{r Phwater POST-HOC, echo=FALSE}
#### hsd tuckey from agricolae::

hsd.t0.phwater <- HSD.test(anova.phwater.to.trans, "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")

hsd.t0.phwater
```
![Diferencias sig.entre tratamientos de phwater en t0. datos transformados.ojo la distribucion no es normal]


## Conductivity

```{r conductivity stats, include=TRUE}
shapiro.test(soilt0$conductivity)
hist(soilt0$conductivity)

soilt0$trans.conduc <- log(soilt0$conductivity)
hist(soilt0$trans.conduc) #datos no normales

anova.conduc.t0.trans <- aov(soilt0$trans.conduc ~ treatment, data = soilt0)
summary(anova.conduc.t0.trans)

leveneTest(soilt0$trans.conduc~ treatment, data= soilt0) 
# el valor de p es mayor que 0.05, se cumple el supuesto de homogenicidad de varianzas.

```

```{r conductivity POST-HOC, echo=FALSE}
#### hsd tuckey from agricolae::

hsd.t0.conduc <- HSD.test(anova.conduc.t0.trans, "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")

hsd.t0.conduc

```
![Diferencias sig.entre tratamientos de phwater en t0. datos transformados. ojo la distribucion no es normal]


## Calcium


```{r stats calcium, include=FALSE}
shapiro.test(soilt0$calcium)
hist(soilt0$calcium)

anova.calcium.to <- aov(calcium ~ treatment, data = soilt0)#datos normales
summary(anova.calcium.to)

leveneTest(calcium ~ treatment, data= soilt0)
# el valor de p es mayor que 0.05, se cumple el supuesto de homogenicidad de varianzas.

```

```{r calcium post-hoc, include=FALSE}


hsd.t0.calcium <- HSD.test(anova.calcium.to, "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")
hsd.t0.calcium

```
![Diferencias sig.entre tratamientos de calcium en t0.]

## Sodium

```{r stats sodium, include=TRUE}

shapiro.test(soilt0$sodium)
hist(soilt0$sodium)

anova.sodium.to <- aov(sodium ~ treatment, data = soilt0)#datos normales
summary(anova.sodium.to)

leveneTest(sodium ~ treatment, data= soilt0)
# el valor de p es mayor que 0.05, se cumple el supuesto de homogenicidad de varianzas.
```


```{r sodium post-hoc, include=TRUE}

hsd.t0.sodium <- HSD.test(anova.sodium.to, "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")
hsd.t0.sodium

```
![no hay diferencias sig. en el t0 entre tratamientos para el sodio]

## Potassium

```{r stats potassium, include=TRUE}
shapiro.test(soilt0$potassium)
hist(soilt0$potassium)

anova.potassium.to <- aov(potassium ~ treatment, data = soilt0)#datos normales
summary(anova.potassium.to)

leveneTest(potassium ~ treatment, data= soilt0)
```


```{r potassium post-hoc, include=TRUE}
hsd.t0.potassium <- HSD.test(anova.potassium.to, "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")
hsd.t0.potassium

```
![Diferencias sig.entre tratamientos de potassium en t0.]

## Nitrogen

```{r stats nitrogen, include=TRUE}

shapiro.test(soilt0$nitrogen)
hist(soilt0$nitrogen)
soilt0$trans.nitrogen <- log(soilt0$nitrogen)
shapiro.test(soilt0$trans.nitrogen)
hist(soilt0$trans.nitrogen)

anova.nitrogen.to.trans <- aov(soilt0$trans.nitrogen ~ treatment, data = soilt0)#datos normales
summary(anova.potassium.to)

leveneTest(soilt0$trans.nitrogen ~ treatment, data= soilt0)

```
```{r nitrogen post-hoc, include=TRUE}
hsd.t0.nitrogen <- HSD.test(anova.nitrogen.to.trans, "treatment", alpha = 0.05)$groups %>% rownames_to_column(var= "treatment")
hsd.t0.nitrogen

```
![Diferencias sig.entre tratamientos nitrogen en t0.]

```{r Correlogram, echo=FALSE}
soil_prop_cor <- soil_prop
soil_prop_cor$rep <- NULL
soil_prop_cor$soil.id <- NULL
soil_prop_cor$treatment <- NULL
soil_prop_cor$time <- NULL
cor.matrix <- soil_prop_cor %>% cor()

cor.mat.test <- cor.mtest(cor.matrix)

corrplot(cor.matrix, p.mat=cor.mat.test$p, sig.level = 0.05, order= "hclust", type= "upper", method= "number", insig = "pch", pch=4,number.cex = 0.75)
```

The most interesing variables seem to be pH.water, organic matter, conductivity and NPKCa values. The rest could be omitted. 

